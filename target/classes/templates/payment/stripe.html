<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/public :: layout(~{::title}, ~{::content}, ~{::js_assets})}">
<head>
    <title>Redirection vers Stripe - Paiement Sécurisé</title>
</head>
<body>
<div th:fragment="content">
    <!-- En-tête de redirection -->
    <div class="payment-header">
        <div class="container">
            <div class="row justify-content-center text-center">
                <div class="col-md-8">
                    <h1 class="payment-title">
                        <i class="fas fa-shield-alt text-warning me-2"></i>
                        Redirection Sécurisée
                    </h1>
                    <p class="payment-subtitle">
                        Vous allez être redirigé vers notre partenaire de paiement sécurisé Stripe
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-6 col-md-8">
                <!-- Carte de redirection -->
                <div class="card redirect-card">
                    <div class="card-body text-center">
                        <!-- Loader animé -->
                        <div class="redirect-loader mb-4">
                            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                        </div>
                        
                        <h3 class="h4 mb-3">Redirection en cours...</h3>
                        <p class="text-muted mb-4">
                            Vous allez être automatiquement redirigé vers la page de paiement sécurisée de Stripe.
                            <br>Veuillez patienter quelques instants.
                        </p>
                        
                        <!-- Bouton de redirection manuelle -->
                        <button id="redirectBtn" class="btn btn-primary btn-lg" style="display: none;">
                            <i class="fas fa-credit-card me-2"></i>
                            Continuer vers le paiement
                        </button>
                        
                        <!-- Bouton de retour en cas de problème -->
                        <div class="mt-4">
                            <a href="/payment" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>
                                Retour à la sélection
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Informations de sécurité -->
                <div class="security-info mt-4">
                    <div class="card border-success">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-2 text-center">
                                    <i class="fas fa-lock text-success fa-2x"></i>
                                </div>
                                <div class="col-10">
                                    <h6 class="text-success mb-1">
                                        <img src="https://stripe.com/img/v3/home/social.png" alt="Stripe" style="height: 20px;" class="me-2" onerror="this.style.display='none'">
                                        Paiement Sécurisé par Stripe
                                    </h6>
                                    <small class="text-muted">
                                        Stripe est utilisé par des millions d'entreprises dans le monde pour traiter 
                                        leurs paiements de manière sécurisée. Vos données bancaires sont chiffrées 
                                        et protégées selon les plus hauts standards de sécurité.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Que se passe-t-il ensuite -->
                <div class="next-steps mt-4">
                    <h5>Que se passe-t-il ensuite ?</h5>
                    <div class="list-group list-group-flush">
                        <div class="list-group-item border-0 px-0">
                            <div class="d-flex align-items-center">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <h6 class="mb-1">Redirection vers Stripe</h6>
                                    <small class="text-muted">Vous êtes redirigé vers la page de paiement sécurisée</small>
                                </div>
                            </div>
                        </div>
                        <div class="list-group-item border-0 px-0">
                            <div class="d-flex align-items-center">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <h6 class="mb-1">Saisie des informations bancaires</h6>
                                    <small class="text-muted">Entrez vos informations de carte bancaire de manière sécurisée</small>
                                </div>
                            </div>
                        </div>
                        <div class="list-group-item border-0 px-0">
                            <div class="d-flex align-items-center">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <h6 class="mb-1">Confirmation du paiement</h6>
                                    <small class="text-muted">Votre paiement est traité et vous recevez une confirmation</small>
                                </div>
                            </div>
                        </div>
                        <div class="list-group-item border-0 px-0">
                            <div class="d-flex align-items-center">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <h6 class="mb-1">Retour et reçu</h6>
                                    <small class="text-muted">Vous êtes redirigé ici et recevez un reçu par email</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Variables pour JavaScript -->
    <div id="stripe-config" 
         th:data-session-id="${sessionId}" 
         th:data-token="${token}"
         th:data-publishable-key="${stripePublishableKey}"
         style="display: none;"></div>
</div>

<div th:fragment="js_assets">
    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const config = document.getElementById('stripe-config');
            const sessionId = config.dataset.sessionId;
            const token = config.dataset.token;
            const publishableKey = config.dataset.publishableKey;
            const redirectBtn = document.getElementById('redirectBtn');
            
            // Configuration Stripe
            const stripe = Stripe(publishableKey);
            
            // Fonction de redirection vers Stripe Checkout
            function redirectToStripe() {
                stripe.redirectToCheckout({
                    sessionId: sessionId
                }).then(function (result) {
                    if (result.error) {
                        console.error('Erreur Stripe:', result.error);
                        showError('Erreur lors de la redirection vers Stripe. Veuillez réessayer.');
                        showManualRedirectButton();
                    }
                }).catch(function(error) {
                    console.error('Erreur de connexion:', error);
                    showError('Problème de connexion. Veuillez vérifier votre connexion internet.');
                    showManualRedirectButton();
                });
            }
            
            // Fonction pour afficher une erreur
            function showError(message) {
                const loader = document.querySelector('.redirect-loader');
                loader.innerHTML = `
                    <div class="alert alert-warning" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${message}
                    </div>
                `;
            }
            
            // Fonction pour afficher le bouton de redirection manuelle
            function showManualRedirectButton() {
                redirectBtn.style.display = 'inline-block';
                redirectBtn.addEventListener('click', function() {
                    redirectToStripe();
                });
            }
            
            // Tentative de redirection automatique après 2 secondes
            setTimeout(function() {
                if (sessionId && publishableKey) {
                    redirectToStripe();
                } else {
                    showError('Configuration de paiement manquante. Veuillez retourner à la sélection du mode de paiement.');
                    showManualRedirectButton();
                }
            }, 2000);
            
            // Affichage du bouton manuel après 10 secondes en cas de problème
            setTimeout(function() {
                if (redirectBtn.style.display === 'none') {
                    showManualRedirectButton();
                }
            }, 10000);
        });
    </script>
    
    <style>
        .payment-header {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
            color: white;
            padding: 2rem 0;
        }
        
        .redirect-card {
            border: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            overflow: hidden;
        }
        
        .redirect-card .card-body {
            padding: 3rem 2rem;
        }
        
        .redirect-loader {
            margin: 2rem 0;
        }
        
        .step-number {
            width: 30px;
            height: 30px;
            background: #007bff;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.875rem;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-content h6 {
            margin-bottom: 0.25rem;
            font-weight: 600;
        }
        
        .list-group-item {
            padding: 1rem 0;
            border-bottom: 1px solid #f8f9fa;
        }
        
        .list-group-item:last-child {
            border-bottom: none;
        }
        
        .security-info .card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        /* Animation du loader */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .redirect-loader .spinner-border {
            animation: pulse 2s infinite;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .payment-header {
                padding: 1.5rem 0;
            }
            
            .redirect-card .card-body {
                padding: 2rem 1.5rem;
            }
            
            .step-number {
                width: 25px;
                height: 25px;
                font-size: 0.75rem;
            }
        }
    </style>
</div>
</body>
</html>