<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: layout(~{::title}, ~{::content}, ~{::js_assets})}">
<head>
    <title>Modifier la Commande</title>
</head>
<body>
<div th:fragment="content">
    <div class="container-fluid">
        <!-- En-tête -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h1 class="h3">
                    <i class="fas fa-edit me-2"></i>
                    Modifier la Commande <span th:text="${order.orderNumber}">N/A</span>
                </h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a th:href="@{/dashboard}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a th:href="@{/orders}">Commandes</a></li>
                        <li class="breadcrumb-item"><a th:href="@{/orders/{id}(id=${order.id})}">Détails</a></li>
                        <li class="breadcrumb-item active">Modifier</li>
                    </ol>
                </nav>
            </div>
            <div class="col-md-4 text-end">
                <a th:href="@{/orders/{id}(id=${order.id})}" class="btn btn-secondary me-2">
                    <i class="fas fa-arrow-left me-1"></i>Retour
                </a>
                <button type="submit" form="orderForm" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i>Enregistrer
                </button>
            </div>
        </div>

        <form th:action="@{/orders/{id}/update(id=${order.id})}" method="post" id="orderForm" 
              onsubmit="return validateOrderForm()">
            <div class="row">
                <!-- Colonne principale -->
                <div class="col-lg-8">
                    <!-- Informations générales -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informations Générales</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="orderNumber" class="form-label">Numéro de Commande</label>
                                        <input type="text" class="form-control" id="orderNumber" 
                                               th:value="${order.orderNumber}" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="orderDate" class="form-label">Date de Commande</label>
                                        <input type="text" class="form-control" id="orderDate" 
                                               th:value="${#temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm')}" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="client" class="form-label">Client *</label>
                                        <select class="form-select" id="client" name="client.id" required>
                                            <option value="">Sélectionner un client</option>
                                            <option th:each="client : ${clients}" 
                                                    th:value="${client.id}"
                                                    th:text="${client.name + (client.companyName != null ? ' (' + client.companyName + ')' : '')}"
                                                    th:selected="${client.id == order.client.id}">
                                                Client
                                            </option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="status" class="form-label">Statut</label>
                                        <select class="form-select" id="status" name="status">
                                            <option th:value="${order.status}" 
                                                    th:text="${order.status}" 
                                                    selected>Statut actuel</option>
                                            <option th:each="status : ${possibleStatuses}" 
                                                    th:value="${status}"
                                                    th:text="${status}">
                                                Statut
                                            </option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Articles de la commande -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>Articles</h5>
                            <button type="button" class="btn btn-success btn-sm" onclick="addOrderItem()">
                                <i class="fas fa-plus me-1"></i>Ajouter un article
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="orderItemsContainer">
                                <!-- Articles existants -->
                                <div th:each="item, itemStat : ${order.orderItems}" 
                                     class="order-item-row border rounded p-3 mb-3"
                                     th:attr="data-index=${itemStat.index}">
                                    <div class="row align-items-center">
                                        <div class="col-md-4">
                                            <label class="form-label">Produit</label>
                                            <select class="form-select product-select" 
                                                    th:name="'orderItems[' + ${itemStat.index} + '].product.id'"
                                                    required onchange="updateProductInfo(this)">
                                                <option value="">Sélectionner un produit</option>
                                                <option th:each="product : ${products}" 
                                                        th:value="${product.id}"
                                                        th:text="${product.name + ' (' + product.reference + ')'}"
                                                        th:selected="${product.id == item.product.id}"
                                                        th:attr="data-price=${product.unitPrice}, data-stock=${product.stock}">
                                                    Produit
                                                </option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Quantité</label>
                                            <input type="number" class="form-control quantity-input" 
                                                   th:name="'orderItems[' + ${itemStat.index} + '].quantity'"
                                                   th:value="${item.quantity}"
                                                   min="1" required onchange="calculateRowTotal(this)">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Prix unitaire</label>
                                            <input type="number" class="form-control price-input" 
                                                   th:name="'orderItems[' + ${itemStat.index} + '].unitPrice'"
                                                   th:value="${item.unitPrice}"
                                                   step="0.01" min="0" required onchange="calculateRowTotal(this)">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Total HT</label>
                                            <input type="text" class="form-control total-display" 
                                                   th:value="${#numbers.formatCurrency(item.totalPriceHT)}"
                                                   readonly>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">&nbsp;</label>
                                            <div>
                                                <button type="button" class="btn btn-danger btn-sm" 
                                                        onclick="removeOrderItem(this)">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Message si aucun article -->
                            <div id="noItemsMessage" class="text-center text-muted py-4" 
                                 th:style="${#lists.isEmpty(order.orderItems)} ? 'display: block;' : 'display: none;'">
                                <i class="fas fa-box-open fa-3x mb-3"></i>
                                <p>Aucun article dans cette commande</p>
                                <button type="button" class="btn btn-primary" onclick="addOrderItem()">
                                    <i class="fas fa-plus me-2"></i>Ajouter le premier article
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Colonne latérale -->
                <div class="col-lg-4">
                    <!-- Totaux -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Totaux</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Total HT:</span>
                                <span id="totalHT" th:text="${#numbers.formatCurrency(order.totalAmountHT ?: 0)}">0,00 €</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>TVA:</span>
                                <span id="totalVAT" th:text="${#numbers.formatCurrency(order.totalVatAmount ?: 0)}">0,00 €</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <span class="h5"><strong>Total TTC:</strong></span>
                                <span id="totalTTC" class="h5 text-primary" 
                                      th:text="${#numbers.formatCurrency(order.totalAmount ?: 0)}">0,00 €</span>
                            </div>
                        </div>
                    </div>

                    <!-- Actions rapides -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Actions Rapides</h5>
                        </div>
                        <div class="card-body">
                            <!-- Bouton Facturation -->
                            <div th:if="${canInvoice}" class="d-grid mb-3">
                                <a th:href="@{/invoices/new(orderId=${order.id})}" class="btn btn-success mb-2">
                                    <i class="fas fa-file-invoice-dollar me-2"></i>
                                    Créer une facture
                                </a>
                                <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#invoicePreviewModal" onclick="generateInvoicePreview()">
                                    <i class="fas fa-eye me-2"></i>
                                    Prévisualiser facture
                                </button>
                            </div>
                            
                            <!-- Facture existante -->
                            <div th:if="${order.invoice != null}" class="d-grid mb-3">
                                <a th:href="@{/invoices/{id}(id=${order.invoice.id})}" class="btn btn-outline-primary">
                                    <i class="fas fa-file-invoice me-2"></i>
                                    Voir la facture
                                </a>
                            </div>

                            <!-- Message d'info -->
                            <div th:if="${!canInvoice and order.invoice == null}" class="alert alert-info">
                                <small>
                                    <i class="fas fa-info-circle me-1"></i>
                                    <span th:if="${!(order.status.name() == 'CONFIRMED' or order.status.name() == 'PROCESSING' or order.status.name() == 'SHIPPED' or order.status.name() == 'DELIVERED')}">
                                        La facturation sera disponible quand la commande sera confirmée.
                                    </span>
                                    <span th:if="${(order.status.name() == 'CONFIRMED' or order.status.name() == 'PROCESSING' or order.status.name() == 'SHIPPED' or order.status.name() == 'DELIVERED') and order.invoice != null}">
                                        Cette commande a déjà été facturée.
                                    </span>
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Statut actuel -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-info me-2"></i>Statut</h5>
                        </div>
                        <div class="card-body">
                            <div class="text-center">
                                <span th:switch="${order.status.name()}" class="badge rounded-pill fs-6">
                                    <span th:case="'DRAFT'" class="bg-secondary">Brouillon</span>
                                    <span th:case="'PENDING'" class="bg-warning text-dark">En attente</span>
                                    <span th:case="'CONFIRMED'" class="bg-primary">Confirmée</span>
                                    <span th:case="'PROCESSING'" class="bg-info">En traitement</span>
                                    <span th:case="'SHIPPED'" class="bg-warning text-dark">Expédiée</span>
                                    <span th:case="'DELIVERED'" class="bg-success">Livrée</span>
                                    <span th:case="'RETURNED'" class="bg-danger">Retournée</span>
                                    <span th:case="'CANCELLED'" class="bg-dark">Annulée</span>
                                </span>
                            </div>
                            <small class="text-muted d-block text-center mt-2">
                                Dernière modification: <span th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm')}">N/A</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Modal de prévisualisation de facture -->
    <div class="modal fade" id="invoicePreviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-eye me-2"></i>
                        Prévisualisation de la Facture
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="invoicePreviewContent">
                        <!-- Le contenu sera chargé ici par JavaScript -->
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    <a th:href="@{/invoices/new(orderId=${order.id})}" class="btn btn-success">
                        <i class="fas fa-file-invoice-dollar me-2"></i>
                        Créer la facture
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:fragment="js_assets">
    <script>
        let orderItemIndex = /*[[${#lists.size(order.orderItems)}]]*/ 0;

        // Liste des produits disponibles (chargée depuis le serveur)
        const products = [
            /*[# th:each="product : ${products ?: #lists.emptyList()}"]*/
            {
                id: /*[[${product?.id ?: 0}]]*/ 0,
                name: /*[[${product?.name ?: ''}]]*/ '',
                reference: /*[[${product?.reference ?: ''}]]*/ '',
                unitPrice: /*[[${product?.unitPrice ?: 0}]]*/ 0,
                stock: /*[[${product?.stock ?: 0}]]*/ 0
            },
            /*[/]*/
        ].filter(p => p.id > 0); // Enlever les produits vides

        function addOrderItem() {
            const container = document.getElementById('orderItemsContainer');
            const noItemsMessage = document.getElementById('noItemsMessage');
            
            let productOptions = '<option value="">Sélectionner un produit</option>';
            products.forEach(product => {
                productOptions += `<option value="${product.id}" data-price="${product.unitPrice}" data-stock="${product.stock}">
                    ${product.name} (${product.reference})
                </option>`;
            });
            
            const itemHtml = `
                <div class="order-item-row border rounded p-3 mb-3" data-index="${orderItemIndex}">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <label class="form-label">Produit</label>
                            <select class="form-select product-select" name="orderItems[${orderItemIndex}].product.id" required onchange="updateProductInfo(this)">
                                ${productOptions}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Quantité</label>
                            <input type="number" class="form-control quantity-input" 
                                   name="orderItems[${orderItemIndex}].quantity"
                                   value="1" min="1" required onchange="calculateRowTotal(this)">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Prix unitaire</label>
                            <input type="number" class="form-control price-input" 
                                   name="orderItems[${orderItemIndex}].unitPrice"
                                   value="0" step="0.01" min="0" required onchange="calculateRowTotal(this)">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Total HT</label>
                            <input type="text" class="form-control total-display" value="0,00 €" readonly>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button type="button" class="btn btn-danger btn-sm" onclick="removeOrderItem(this)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', itemHtml);
            noItemsMessage.style.display = 'none';
            orderItemIndex++;
            
            // Réindexer tous les champs
            reindexOrderItems();
        }

        function removeOrderItem(button) {
            const row = button.closest('.order-item-row');
            row.remove();
            
            // Vérifier s'il reste des articles
            const container = document.getElementById('orderItemsContainer');
            const noItemsMessage = document.getElementById('noItemsMessage');
            
            if (container.children.length === 0) {
                noItemsMessage.style.display = 'block';
            }
            
            // Réindexer et recalculer
            reindexOrderItems();
            calculateOrderTotals();
        }

        function updateProductInfo(selectElement) {
            const option = selectElement.selectedOptions[0];
            const row = selectElement.closest('.order-item-row');
            
            if (option && option.value) {
                const price = option.getAttribute('data-price');
                const stock = option.getAttribute('data-stock');
                
                const priceInput = row.querySelector('.price-input');
                priceInput.value = price || 0;
                
                calculateRowTotal(priceInput);
            }
        }

        function calculateRowTotal(input) {
            const row = input.closest('.order-item-row');
            const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
            const price = parseFloat(row.querySelector('.price-input').value) || 0;
            const total = quantity * price;
            
            const totalDisplay = row.querySelector('.total-display');
            totalDisplay.value = formatCurrency(total);
            
            calculateOrderTotals();
        }

        function calculateOrderTotals() {
            let totalHT = 0;
            
            document.querySelectorAll('.order-item-row').forEach(row => {
                const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
                const price = parseFloat(row.querySelector('.price-input').value) || 0;
                totalHT += quantity * price;
            });
            
            const vatRate = 0.20; // 20% TVA
            const totalVAT = totalHT * vatRate;
            const totalTTC = totalHT + totalVAT;
            
            document.getElementById('totalHT').textContent = formatCurrency(totalHT);
            document.getElementById('totalVAT').textContent = formatCurrency(totalVAT);
            document.getElementById('totalTTC').textContent = formatCurrency(totalTTC);
        }

        function reindexOrderItems() {
            const rows = document.querySelectorAll('.order-item-row');
            rows.forEach((row, index) => {
                row.setAttribute('data-index', index);
                
                // Mettre à jour les noms des champs
                const inputs = row.querySelectorAll('input, select');
                inputs.forEach(input => {
                    if (input.name) {
                        input.name = input.name.replace(/\[\d+\]/, `[${index}]`);
                    }
                });
            });
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-FR', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount);
        }

        function saveOrder() {
            const form = document.getElementById('orderForm');
            
            // Validation basique
            const client = document.getElementById('client').value;
            if (!client) {
                alert('Veuillez sélectionner un client');
                return;
            }
            
            const orderItems = document.querySelectorAll('.order-item-row');
            if (orderItems.length === 0) {
                alert('Veuillez ajouter au moins un article');
                return;
            }
            
            // Vérifier que tous les articles sont valides
            let isValid = true;
            orderItems.forEach(row => {
                const product = row.querySelector('.product-select').value;
                const quantity = row.querySelector('.quantity-input').value;
                const price = row.querySelector('.price-input').value;
                
                if (!product || !quantity || !price) {
                    isValid = false;
                }
            });
            
            if (!isValid) {
                alert('Veuillez compléter tous les champs des articles');
                return;
            }
            
            form.submit();
        }

        function previewInvoice() {
            const modal = new bootstrap.Modal(document.getElementById('invoicePreviewModal'));
            const content = document.getElementById('invoicePreviewContent');
            
            // Afficher le modal avec spinner
            content.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                    <p class="mt-2">Génération de la prévisualisation...</p>
                </div>
            `;
            modal.show();
            
            // Générer la prévisualisation
            generateInvoicePreview();
        }

        function generateInvoicePreview() {
            const content = document.getElementById('invoicePreviewContent');
            const orderNumber = /*[[${ order.orderNumber}]]*/ '';
            const clientName = /*[[${ order.client.name}]]*/ '';
            const orderDate = /*[[${ #temporals.format(order.orderDate, 'dd/MM/yyyy')}]]*/ '';
            
            let totalHT = 0;
            let previewItems = '';
            
            // Parcourir les articles actuels dans le formulaire
            document.querySelectorAll('.order-item-row').forEach(row => {
                const productSelect = row.querySelector('.product-select');
                const quantity = parseInt(row.querySelector('.quantity-input').value) || 0;
                const price = parseFloat(row.querySelector('.price-input').value) || 0;
                const total = quantity * price;
                totalHT += total;
                
                if (productSelect.value && quantity > 0) {
                    const productName = productSelect.selectedOptions[0].text;
                    previewItems += `
                        <tr>
                            <td>${productName}</td>
                            <td class="text-center">${quantity}</td>
                            <td class="text-end">${formatCurrency(price)}</td>
                            <td class="text-end"><strong>${formatCurrency(total)}</strong></td>
                        </tr>
                    `;
                }
            });
            
            const vatAmount = totalHT * 0.20;
            const totalTTC = totalHT + vatAmount;
            
            const previewHtml = `
                <div class="invoice-preview">
                    <div class="row mb-4">
                        <div class="col-6">
                            <h4>GESCOM</h4>
                            <p class="mb-0">123 Rue Example</p>
                            <p class="mb-0">75000 Paris</p>
                        </div>
                        <div class="col-6 text-end">
                            <h5>FACTURE</h5>
                            <p class="mb-0">Basée sur: ${orderNumber}</p>
                            <p class="mb-0">Date: ${new Date().toLocaleDateString('fr-FR')}</p>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-6">
                            <h6>Client:</h6>
                            <p class="mb-0"><strong>${clientName}</strong></p>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Produit</th>
                                    <th class="text-center">Quantité</th>
                                    <th class="text-end">Prix unitaire</th>
                                    <th class="text-end">Total HT</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${previewItems}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="row">
                        <div class="col-6 offset-6">
                            <table class="table table-sm">
                                <tr>
                                    <td>Total HT:</td>
                                    <td class="text-end">${formatCurrency(totalHT)}</td>
                                </tr>
                                <tr>
                                    <td>TVA (20%):</td>
                                    <td class="text-end">${formatCurrency(vatAmount)}</td>
                                </tr>
                                <tr class="table-primary">
                                    <td><strong>Total TTC:</strong></td>
                                    <td class="text-end"><strong>${formatCurrency(totalTTC)}</strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            content.innerHTML = previewHtml;
        }

        // Fonction de validation simple pour le formulaire
        function validateOrderForm() {
            const client = document.getElementById('client');
            if (!client || !client.value) {
                alert('Veuillez sélectionner un client');
                return false;
            }
            return true;
        }

        // Calculer les totaux au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            calculateOrderTotals();
        });
    </script>
</div>
</body>
</html>