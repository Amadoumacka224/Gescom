<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: layout(~{::title}, ~{::content}, ~{::css_assets})}">
<head>
    <title th:text="'Détails Commande ' + ${order.orderNumber}">Détails Commande</title>
</head>
<body>

<div th:fragment="css_assets">
<style>
    /* Force tous les textes à être noirs pour éviter le problème de texte blanc */
    .order-detail-page {
        color: #212529 !important;
    }
    
    .order-detail-page * {
        color: inherit !important;
    }
    
    .order-detail-page h1,
    .order-detail-page h2,
    .order-detail-page h3,
    .order-detail-page h4,
    .order-detail-page h5,
    .order-detail-page h6,
    .order-detail-page p,
    .order-detail-page span,
    .order-detail-page td,
    .order-detail-page th,
    .order-detail-page div,
    .order-detail-page strong,
    .order-detail-page small {
        color: #212529 !important;
    }
    
    /* Exceptions pour les liens */
    .order-detail-page a {
        color: #0d6efd !important;
    }
    
    /* Exceptions pour les badges et boutons qui ont leurs propres couleurs */
    .order-detail-page .btn,
    .order-detail-page .badge,
    .order-detail-page .text-primary,
    .order-detail-page .text-success,
    .order-detail-page .text-danger,
    .order-detail-page .text-warning,
    .order-detail-page .text-muted {
        color: inherit !important;
    }
    
    /* Headers de table */
    .order-detail-page .table th {
        color: #212529 !important;
        background-color: #f8f9fa !important;
    }
    
    /* Texte des alertes */
    .order-detail-page .alert {
        color: #0c5460 !important;
    }
</style>
</div>

<div th:fragment="content" class="order-detail-page">
    <!-- En-tête -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1><i class="fas fa-shopping-cart me-2"></i>Détails Commande <span th:text="${order.orderNumber}">CMD-001</span></h1>
        </div>
        <div>
            <a th:href="@{/orders}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Retour à la liste
            </a>
        </div>
    </div>

    <!-- Informations de base -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Informations générales</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Numéro:</strong> <span th:text="${order.orderNumber}">CMD-001</span></p>
                    <p><strong>Date:</strong> <span th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm')}">01/01/2024</span></p>
                    <p><strong>Statut:</strong> <span th:text="${order.status}">DRAFT</span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>Client:</strong> <span th:text="${order.client?.name ?: 'Non défini'}">Client</span></p>
                    <p><strong>Commercial:</strong> <span th:text="${order.user?.username ?: 'Non défini'}">User</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Articles -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Articles (<span th:text="${#lists.size(order.orderItems)}">0</span>)</h5>
        </div>
        <div class="card-body">
            <div th:if="${#lists.isEmpty(order.orderItems)}" class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>Aucun article dans cette commande.
            </div>
            
            <div th:unless="${#lists.isEmpty(order.orderItems)}">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Produit</th>
                                <th>Quantité</th>
                                <th>Prix unitaire</th>
                                <th>Total HT</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="item : ${order.orderItems}">
                                <td>
                                    <strong th:text="${item.product?.name ?: 'Produit non défini'}">Produit</strong><br>
                                    <small class="text-muted" th:text="'Réf: ' + ${item.product?.reference ?: 'N/A'}">Référence</small>
                                </td>
                                <td th:text="${item.quantity ?: 0}">0</td>
                                <td th:text="${#numbers.formatCurrency(item.unitPrice ?: 0)}">0,00 €</td>
                                <td th:text="${#numbers.formatCurrency(item.totalPriceHT ?: 0)}">0,00 €</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Totaux -->
    <div class="row">
        <div class="col-md-6 offset-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Récapitulatif financier</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Total HT:</span>
                        <span th:text="${#numbers.formatCurrency(order.totalAmountHT ?: 0)}">0,00 €</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>TVA:</span>
                        <span th:text="${#numbers.formatCurrency(order.totalVatAmount ?: 0)}">0,00 €</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <span class="h5"><strong>Total TTC:</strong></span>
                        <span class="h5 text-primary" th:text="${#numbers.formatCurrency(order.totalAmount ?: 0)}">0,00 €</span>
                    </div>
                    
                    <!-- Bouton Facturer -->
                    <div class="mt-3 d-grid">
                        <div th:if="${(order.status?.name() == 'CONFIRMED' or order.status?.name() == 'PROCESSING' or order.status?.name() == 'SHIPPED' or order.status?.name() == 'DELIVERED') and order.invoice == null}">
                            <a th:href="@{/invoices/new(orderId=${order.id})}" class="btn btn-success">
                                <i class="fas fa-file-invoice-dollar me-2"></i>Créer une facture
                            </a>
                        </div>
                        <div th:if="${order.invoice != null}">
                            <a th:href="@{/invoices/{id}(id=${order.invoice.id})}" class="btn btn-outline-primary">
                                <i class="fas fa-file-invoice me-2"></i>Voir la facture
                            </a>
                        </div>
                        <div th:unless="${(order.status?.name() == 'CONFIRMED' or order.status?.name() == 'DELIVERED')}">
                            <small class="text-muted">Bouton facturer disponible pour les commandes confirmées ou livrées</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Debug Info -->
    <div class="card mt-4 bg-light">
        <div class="card-header">
            <h6 class="mb-0">Informations de debug</h6>
        </div>
        <div class="card-body">
            <p><strong>ID Commande:</strong> <span th:text="${order.id}">N/A</span></p>
            <p><strong>Nombre d'articles:</strong> <span th:text="${#lists.size(order.orderItems)}">0</span></p>
            <p><strong>Total HT:</strong> <span th:text="${order.totalAmountHT}">null</span></p>
            <p><strong>Total TTC:</strong> <span th:text="${order.totalAmount}">null</span></p>
            <p><strong>Statut:</strong> <span th:text="${order.status}">null</span></p>
            <p><strong>Invoice:</strong> <span th:text="${order.invoice?.id ?: 'null'}">null</span></p>
        </div>
    </div>
</div>
</body>
</html>