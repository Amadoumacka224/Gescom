<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: layout(~{::title}, ~{::content}, ~{::js_assets})}">
<head>
    <title>Mon Profil - GESCOM</title>
</head>
<body>
<div th:fragment="content">
    <style>
        /* === STYLES POUR LA PAGE PROFIL === */
        .profile-page {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }
        
        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
        }
        
        .profile-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
            transition: all 0.3s ease;
        }
        
        .profile-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(31, 38, 135, 0.15);
        }
        
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-gradient:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            color: white;
        }
        
        .password-strength {
            height: 6px;
            border-radius: 3px;
            margin-top: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .password-requirements {
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        
        .requirement {
            display: flex;
            align-items: center;
            margin-bottom: 0.25rem;
        }
        
        .requirement.valid {
            color: #28a745;
        }
        
        .requirement.invalid {
            color: #dc3545;
        }
        
        .activity-item {
            border-left: 3px solid #667eea;
            background: rgba(102, 126, 234, 0.05);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0 0.5rem 0.5rem 0;
        }
        
        .section-title {
            color: #495057;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }
        
        @media (max-width: 768px) {
            .profile-header {
                text-align: center;
                padding: 1.5rem;
            }
            
            .profile-avatar {
                width: 80px;
                height: 80px;
                font-size: 2rem;
                margin: 0 auto 1rem;
            }
        }
    </style>
    <!-- En-tête de la page -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-2">
                    <li class="breadcrumb-item">
                        <a href="/dashboard" class="text-decoration-none">
                            <i class="fas fa-home me-1"></i>Tableau de bord
                        </a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">Mon Profil</li>
                </ol>
            </nav>
            
            <div class="d-flex align-items-center mb-2">
                <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                    <i class="fas fa-user text-primary"></i>
                </div>
                <div>
                    <h1 class="h3 mb-1">Mon Profil</h1>
                    <p class="text-muted mb-0">Gérez vos informations personnelles et paramètres de compte</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages d'alerte -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show mb-4" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div class="row">
        <!-- Section principale -->
        <div class="col-lg-8">
            <!-- Informations personnelles -->
            <div class="profile-card card mb-4 border-0">
                <div class="card-header bg-transparent border-bottom">
                    <h5 class="mb-0 section-title">
                        <i class="fas fa-user me-2 text-primary"></i>
                        Informations personnelles
                    </h5>
                </div>
                <div class="card-body">
                    <form th:action="@{/user/profile/update}" method="post" th:object="${user}">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="firstName" class="form-label fw-medium">
                                    <i class="fas fa-user text-primary me-1"></i>Prénom
                                    <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="firstName" th:field="*{firstName}" 
                                       placeholder="Votre prénom" required>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('firstName')}" 
                                     th:errors="*{firstName}"></div>
                            </div>

                            <div class="col-md-6">
                                <label for="lastName" class="form-label fw-medium">
                                    <i class="fas fa-user text-primary me-1"></i>Nom
                                    <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="lastName" th:field="*{lastName}" 
                                       placeholder="Votre nom" required>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('lastName')}" 
                                     th:errors="*{lastName}"></div>
                            </div>

                            <div class="col-md-6">
                                <label for="email" class="form-label fw-medium">
                                    <i class="fas fa-envelope text-primary me-1"></i>Email
                                    <span class="text-danger">*</span>
                                </label>
                                <input type="email" class="form-control" id="email" th:field="*{email}" 
                                       placeholder="votre.email@example.com" required>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('email')}" 
                                     th:errors="*{email}"></div>
                            </div>

                            <div class="col-md-6">
                                <label for="phoneNumber" class="form-label fw-medium">
                                    <i class="fas fa-phone text-primary me-1"></i>Téléphone
                                </label>
                                <input type="tel" class="form-control" id="phoneNumber" th:field="*{phoneNumber}" 
                                       placeholder="+33 1 23 45 67 89">
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('phoneNumber')}" 
                                     th:errors="*{phoneNumber}"></div>
                            </div>

                            <div class="col-12">
                                <label for="address" class="form-label fw-medium">
                                    <i class="fas fa-map-marker-alt text-primary me-1"></i>Adresse
                                </label>
                                <textarea class="form-control" id="address" th:field="*{address}" rows="2" 
                                          placeholder="Votre adresse complète"></textarea>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end mt-4">
                            <button type="submit" class="btn btn-gradient px-4">
                                <i class="fas fa-save me-1"></i>
                                Enregistrer les modifications
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Changement de mot de passe -->
            <div class="profile-card card mb-4 border-0">
                <div class="card-header bg-transparent border-bottom">
                    <h5 class="mb-0 section-title">
                        <i class="fas fa-lock me-2 text-primary"></i>
                        Sécurité et mot de passe
                    </h5>
                </div>
                <div class="card-body">
                    <form th:action="@{/user/profile/change-password}" method="post" id="passwordForm">
                        <div class="row g-3">
                            <div class="col-12">
                                <label for="currentPassword" class="form-label fw-medium">
                                    <i class="fas fa-key text-primary me-1"></i>Mot de passe actuel
                                    <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="currentPassword" 
                                           name="currentPassword" placeholder="Votre mot de passe actuel" required>
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('currentPassword')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label for="newPassword" class="form-label fw-medium">
                                    <i class="fas fa-lock text-primary me-1"></i>Nouveau mot de passe
                                    <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="newPassword" 
                                           name="newPassword" placeholder="Nouveau mot de passe" required 
                                           minlength="8">
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('newPassword')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <div class="form-text">
                                    <i class="fas fa-info-circle text-info me-1"></i>
                                    Minimum 8 caractères, avec majuscules, minuscules et chiffres
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label for="confirmPassword" class="form-label fw-medium">
                                    <i class="fas fa-lock text-primary me-1"></i>Confirmer le mot de passe
                                    <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="confirmPassword" 
                                           name="confirmPassword" placeholder="Confirmer le mot de passe" required>
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('confirmPassword')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Indicateur de force du mot de passe -->
                        <div class="mt-3">
                            <div class="small fw-medium mb-1">Force du mot de passe :</div>
                            <div class="progress" style="height: 4px;">
                                <div id="passwordStrength" class="progress-bar" role="progressbar" 
                                     style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end mt-4">
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-key me-1"></i>
                                Changer le mot de passe
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Préférences -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>
                        Préférences
                    </h5>
                </div>
                <div class="card-body">
                    <form th:action="@{/user/profile/preferences}" method="post">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="language" class="form-label fw-medium">
                                    <i class="fas fa-globe text-primary me-1"></i>Langue
                                </label>
                                <select class="form-select" id="language" name="language">
                                    <option value="fr" selected>Français</option>
                                    <option value="en">English</option>
                                    <option value="es">Español</option>
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label for="timezone" class="form-label fw-medium">
                                    <i class="fas fa-clock text-primary me-1"></i>Fuseau horaire
                                </label>
                                <select class="form-select" id="timezone" name="timezone">
                                    <option value="Europe/Paris" selected>Europe/Paris (CET)</option>
                                    <option value="Europe/London">Europe/London (GMT)</option>
                                    <option value="America/New_York">America/New_York (EST)</option>
                                </select>
                            </div>

                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="emailNotifications" 
                                           name="emailNotifications" checked>
                                    <label class="form-check-label fw-medium" for="emailNotifications">
                                        <i class="fas fa-bell text-primary me-1"></i>
                                        Recevoir les notifications par email
                                    </label>
                                </div>
                            </div>

                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="darkMode" name="darkMode">
                                    <label class="form-check-label fw-medium" for="darkMode">
                                        <i class="fas fa-moon text-primary me-1"></i>
                                        Mode sombre
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end mt-4">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-check me-1"></i>
                                Sauvegarder les préférences
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Photo de profil -->
            <div class="profile-card card mb-4 border-0">
                <div class="card-header bg-transparent border-bottom">
                    <h5 class="mb-0 section-title">
                        <i class="fas fa-camera me-2 text-primary"></i>
                        Photo de profil
                    </h5>
                </div>
                <div class="card-body text-center">
                    <div class="position-relative d-inline-block mb-3">
                        <img th:src="${user.avatarUrl} ?: '/images/default-avatar.png'" 
                             alt="Photo de profil" class="rounded-circle mb-3" 
                             style="width: 120px; height: 120px; object-fit: cover;">
                        <button class="btn btn-primary btn-sm position-absolute bottom-0 end-0 rounded-circle" 
                                style="width: 32px; height: 32px;" onclick="document.getElementById('avatarUpload').click()">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                    
                    <form th:action="@{/user/profile/upload-avatar}" method="post" enctype="multipart/form-data" id="avatarForm">
                        <input type="file" id="avatarUpload" name="avatar" accept="image/*" 
                               style="display: none;" onchange="previewAvatar(this)">
                    </form>
                    
                    <p class="text-muted small mb-0">
                        Formats acceptés : JPG, PNG<br>
                        Taille max : 2 MB
                    </p>
                </div>
            </div>

            <!-- Informations du compte -->
            <div class="profile-card card mb-4 border-0">
                <div class="card-header bg-transparent border-bottom">
                    <h5 class="mb-0 section-title">
                        <i class="fas fa-info-circle me-2 text-primary"></i>
                        Informations du compte
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-2 text-sm">
                        <div class="col-5 fw-medium text-muted">ID :</div>
                        <div class="col-7" th:text="${user.id}">#12345</div>
                        
                        <div class="col-5 fw-medium text-muted">Statut :</div>
                        <div class="col-7">
                            <span class="badge bg-success" th:if="${user.enabled}">Actif</span>
                            <span class="badge bg-danger" th:unless="${user.enabled}">Inactif</span>
                        </div>
                        
                        <div class="col-5 fw-medium text-muted">Rôle :</div>
                        <div class="col-7">
                            <span class="badge bg-primary" th:each="role : ${user.roles}" th:text="${role.name}">ADMIN</span>
                        </div>
                        
                        <div class="col-5 fw-medium text-muted">Créé le :</div>
                        <div class="col-7" th:text="${#temporals.format(user.createdAt, 'dd/MM/yyyy')}">01/01/2024</div>
                        
                        <div class="col-5 fw-medium text-muted">Dernière connexion :</div>
                        <div class="col-7" th:text="${user.lastLoginAt != null ? #temporals.format(user.lastLoginAt, 'dd/MM/yyyy HH:mm') : 'Jamais'}">
                            01/01/2024 14:30
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistiques -->
            <div class="profile-card card border-0">
                <div class="card-header bg-transparent border-bottom">
                    <h5 class="mb-0 section-title">
                        <i class="fas fa-chart-bar me-2 text-primary"></i>
                        Mes statistiques
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="stats-card">
                                <i class="fas fa-users mb-2 d-block" style="font-size: 1.5rem;"></i>
                                <div class="stats-number" th:text="${stats.clientsCount ?: 0}">25</div>
                                <small>Clients</small>
                            </div>
                        </div>
                        
                        <div class="col-6">
                            <div class="stats-card">
                                <i class="fas fa-shopping-cart mb-2 d-block" style="font-size: 1.5rem;"></i>
                                <div class="stats-number" th:text="${stats.ordersCount ?: 0}">142</div>
                                <small>Commandes</small>
                            </div>
                        </div>
                        
                        <div class="col-12 text-center">
                            <div class="bg-info bg-opacity-10 rounded p-3">
                                <i class="fas fa-euro-sign text-info mb-2 d-block" style="font-size: 1.5rem;"></i>
                                <div class="fw-bold h4 mb-1" th:text="${stats.totalRevenue != null ? #numbers.formatDecimal(stats.totalRevenue, 1, 2) + ' €' : '0,00 €'}">
                                    15 247,50 €
                                </div>
                                <small class="text-muted">Chiffre d'affaires total</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:fragment="js_assets">
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Validation du formulaire de mot de passe
        const passwordForm = document.getElementById('passwordForm');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const passwordStrengthBar = document.getElementById('passwordStrength');
        
        // Vérification de la force du mot de passe
        newPasswordInput.addEventListener('input', function() {
            const password = this.value;
            const strength = calculatePasswordStrength(password);
            updatePasswordStrengthBar(strength);
        });
        
        // Validation de confirmation du mot de passe
        confirmPasswordInput.addEventListener('input', function() {
            if (this.value !== newPasswordInput.value) {
                this.setCustomValidity('Les mots de passe ne correspondent pas');
                this.classList.add('is-invalid');
            } else {
                this.setCustomValidity('');
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            }
        });
        
        // Soumission du formulaire
        passwordForm.addEventListener('submit', function(e) {
            if (newPasswordInput.value !== confirmPasswordInput.value) {
                e.preventDefault();
                alert('Les mots de passe ne correspondent pas');
                return;
            }
        });
    });
    
    // Fonction pour basculer la visibilité du mot de passe
    function togglePassword(fieldId) {
        const field = document.getElementById(fieldId);
        const button = field.nextElementSibling.querySelector('i');
        
        if (field.type === 'password') {
            field.type = 'text';
            button.classList.replace('fa-eye', 'fa-eye-slash');
        } else {
            field.type = 'password';
            button.classList.replace('fa-eye-slash', 'fa-eye');
        }
    }
    
    // Calcul de la force du mot de passe
    function calculatePasswordStrength(password) {
        let score = 0;
        
        if (password.length >= 8) score += 25;
        if (password.match(/[a-z]/)) score += 25;
        if (password.match(/[A-Z]/)) score += 25;
        if (password.match(/[0-9]/)) score += 15;
        if (password.match(/[^a-zA-Z0-9]/)) score += 10;
        
        return Math.min(score, 100);
    }
    
    // Mise à jour de la barre de force du mot de passe
    function updatePasswordStrengthBar(strength) {
        const bar = document.getElementById('passwordStrength');
        bar.style.width = strength + '%';
        bar.setAttribute('aria-valuenow', strength);
        
        // Couleur en fonction de la force
        bar.className = 'progress-bar';
        if (strength < 30) {
            bar.classList.add('bg-danger');
        } else if (strength < 60) {
            bar.classList.add('bg-warning');
        } else if (strength < 90) {
            bar.classList.add('bg-info');
        } else {
            bar.classList.add('bg-success');
        }
    }
    
    // Prévisualisation de l'avatar
    function previewAvatar(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            
            // Vérification de la taille (2MB max)
            if (file.size > 2 * 1024 * 1024) {
                alert('Le fichier est trop volumineux. Taille maximum : 2MB');
                input.value = '';
                return;
            }
            
            // Vérification du type
            if (!file.type.startsWith('image/')) {
                alert('Veuillez sélectionner un fichier image');
                input.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.querySelector('img[alt="Photo de profil"]');
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
            
            // Soumission automatique du formulaire
            document.getElementById('avatarForm').submit();
        }
    }
    </script>
</div>
</body>
</html>