<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: layout(~{::title}, ~{::content}, ~{})}">
<head>
    <title>Tableau de bord Manager</title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Date Range Picker -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
</head>
<body>
<style>
    @media print {
        .btn, .dropdown, nav, .card-header .btn {
            display: none !important;
        }
    }

    .metric-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }

    .progress {
        background-color: rgba(0,0,0,0.1);
    }

    .table th {
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
    }

    .btn-group .btn.active {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: white;
    }

    #teamPerformanceChart {
        height: 300px !important;
    }

    .list-group-item {
        border-left: none;
        border-right: none;
    }

    .list-group-item:first-child {
        border-top: none;
    }

    .list-group-item:last-child {
        border-bottom: none;
    }
</style>
<div th:fragment="content">
    <!-- En-tête avec filtres -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <div>
            <h1>
                <i class="fas fa-chart-line me-2 text-primary"></i>
                Tableau de bord Manager
            </h1>
            <p class="text-muted mb-0">
                <i class="fas fa-users me-1"></i>

                <span class="mx-2">•</span>
                <i class="fas fa-calendar me-1"></i>
                Période : <span id="currentPeriod" th:text="${dashboardData?.periodDays ?: 30} + ' jours'">30 jours</span>
            </p>
        </div>
        <div class="d-flex gap-2 flex-wrap">
            <!-- Sélecteur de période -->
            <div class="btn-group" role="group">
                <a th:href="@{/dashboard(days=7)}" class="btn btn-outline-primary btn-sm"
                   th:classappend="${dashboardData?.periodDays == 7} ? 'active' : ''">
                    <i class="fas fa-calendar-day me-1"></i>7j
                </a>
                <a th:href="@{/dashboard(days=30)}" class="btn btn-outline-primary btn-sm"
                   th:classappend="${dashboardData?.periodDays == 30} ? 'active' : ''">
                    <i class="fas fa-calendar-week me-1"></i>30j
                </a>
                <a th:href="@{/dashboard(days=90)}" class="btn btn-outline-primary btn-sm"
                   th:classappend="${dashboardData?.periodDays == 90} ? 'active' : ''">
                    <i class="fas fa-calendar-alt me-1"></i>90j
                </a>
            </div>

            <!-- Date range picker -->
            <button class="btn btn-outline-secondary btn-sm" id="dateRangePicker">
                <i class="fas fa-calendar-range me-1"></i>Période personnalisée
            </button>

            <!-- Actions -->
            <div class="btn-group">
                <button class="btn btn-success btn-sm" onclick="exportReport()">
                    <i class="fas fa-download me-1"></i>Exporter
                </button>
                <button class="btn btn-info btn-sm" onclick="refreshData()">
                    <i class="fas fa-sync-alt me-1"></i>Actualiser
                </button>
            </div>
        </div>
    </div>

    <!-- Alertes et notifications -->
    <div th:if="${dashboardData?.alerts}" class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning alert-dismissible fade show" th:each="alert : ${dashboardData.alerts}">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Attention :</strong> <span th:text="${alert}">Message d'alerte</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>

    <!-- Métriques principales -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card metric-card border-primary">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title text-muted mb-2">
                                <i class="fas fa-euro-sign me-1"></i>CA Équipe
                            </h6>
                            <h2 class="text-primary mb-1" th:text="${dashboardData?.teamRevenue ? #numbers.formatCurrency(dashboardData.teamRevenue) : '0 €'}">0 €</h2>
                            <small class="text-muted">
                                <span th:text="${dashboardData?.teamMembers ? #lists.size(dashboardData.teamMembers) : 0}">0</span> vendeurs actifs
                            </small>
                        </div>
                        <div class="ms-3">
                            <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                <i class="fas fa-chart-line text-primary fa-lg"></i>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="d-flex align-items-center">
                            <span class="badge bg-success me-2" th:if="${dashboardData?.revenueGrowth != null and dashboardData.revenueGrowth > 0}">
                                <i class="fas fa-arrow-up me-1"></i><span th:text="${#numbers.formatDecimal(dashboardData.revenueGrowth, 1, 1)}">0</span>%
                            </span>
                            <span class="badge bg-danger me-2" th:if="${dashboardData?.revenueGrowth != null and dashboardData.revenueGrowth < 0}">
                                <i class="fas fa-arrow-down me-1"></i><span th:text="${#numbers.formatDecimal(dashboardData.revenueGrowth, 1, 1)}">0</span>%
                            </span>
                            <small class="text-muted">vs période précédente</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card metric-card" th:classappend="'border-' + ${dashboardData?.targetStatusClass ?: 'secondary'}">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title text-muted mb-2">
                                <i class="fas fa-bullseye me-1"></i>Objectif Global
                            </h6>
                            <h2 class="mb-1" th:classappend="'text-' + ${dashboardData?.targetStatusClass ?: 'secondary'}"
                                th:text="${dashboardData?.targetAchievement ? (#numbers.formatDecimal(dashboardData.targetAchievement, 1, 1) + '%') : '0%'}">0%</h2>
                            <small class="text-muted" th:text="${dashboardData?.targetStatus ?: 'Aucun objectif'}">Status</small>
                        </div>
                        <div class="ms-3">
                            <div class="rounded-circle d-flex align-items-center justify-content-center"
                                 style="width: 50px; height: 50px;"
                                 th:classappend="'bg-' + ${dashboardData?.targetStatusClass ?: 'secondary'} + ' bg-opacity-10'">
                                <i class="fas fa-target fa-lg" th:classappend="'text-' + ${dashboardData?.targetStatusClass ?: 'secondary'}"></i>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar"
                                 th:classappend="'bg-' + ${dashboardData?.targetStatusClass ?: 'secondary'}"
                                 th:style="'width: ' + ${dashboardData?.targetAchievement ?: 0} + '%'"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card metric-card border-success">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title text-muted mb-2">
                                <i class="fas fa-shopping-cart me-1"></i>Commandes
                            </h6>
                            <h2 class="text-success mb-1" th:text="${dashboardData?.teamOrders ?: 0}">0</h2>
                            <small class="text-muted">Cette période</small>
                        </div>
                        <div class="ms-3">
                            <div class="bg-success bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                <i class="fas fa-shopping-bag text-success fa-lg"></i>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-chart-bar me-1"></i>
                            Moyenne: <span th:text="${dashboardData?.avgOrderValue ? #numbers.formatCurrency(dashboardData.avgOrderValue) : '0 €'}">0 €</span> par commande
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card metric-card border-info">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title text-muted mb-2">
                                <i class="fas fa-users me-1"></i>Clients
                            </h6>
                            <h2 class="text-info mb-1" th:text="${dashboardData?.teamClients ?: 0}">0</h2>
                            <small class="text-muted">
                                +<span th:text="${dashboardData?.newClientsThisPeriod ?: 0}">0</span> nouveaux
                            </small>
                        </div>
                        <div class="ms-3">
                            <div class="bg-info bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                <i class="fas fa-user-plus text-info fa-lg"></i>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-percentage me-1"></i>
                            Taux conversion: <span th:text="${dashboardData?.conversionRate ? (#numbers.formatDecimal(dashboardData.conversionRate, 1, 1) + '%') : '0%'}">0%</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphiques et équipe -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Performance par vendeur
                    </h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary active" onclick="switchChart('revenue')">CA</button>
                        <button type="button" class="btn btn-outline-primary" onclick="switchChart('orders')">Commandes</button>
                        <button type="button" class="btn btn-outline-primary" onclick="switchChart('clients')">Clients</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="position-relative">
                        <canvas id="teamPerformanceChart" width="400" height="200"></canvas>
                        <div id="chartLoader" class="position-absolute top-50 start-50 translate-middle" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>Mon Équipe
                    </h5>
                    <button class="btn btn-outline-primary btn-sm" onclick="manageTeam()">
                        <i class="fas fa-cog me-1"></i>Gérer
                    </button>
                </div>
                <div class="card-body">
                    <div th:if="${dashboardData?.teamMembers == null or #lists.isEmpty(dashboardData.teamMembers)}" class="text-center text-muted py-4">
                        <i class="fas fa-users fa-2x mb-2"></i>
                        <p class="mb-0">Aucun membre d'équipe</p>
                        <small>Assignez des commerciaux à votre équipe</small>
                    </div>

                    <div th:if="${dashboardData?.teamMembers != null}" class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0 py-3"
                             th:each="member, iterStat : ${dashboardData.teamMembers}">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 40px; height: 40px;">
                                        <i class="fas fa-user text-primary"></i>
                                    </div>
                                </div>
                                <div>
                                    <strong th:text="${member?.firstName + ' ' + member?.lastName}">Nom Prénom</strong>
                                    <br><small class="text-muted" th:text="${member?.email}">email@exemple.com</small>
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="btn-group btn-group-sm me-2">
                                    <button class="btn btn-outline-primary btn-sm" th:onclick="'viewMemberDetails(' + ${member?.id} + ')'" title="Voir détails">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-success btn-sm" th:onclick="'contactMember(\'' + ${member?.email} + '\')'" title="Contacter">
                                        <i class="fas fa-envelope"></i>
                                    </button>
                                </div>
                                <span class="badge bg-success rounded-pill" th:if="${member?.isActive}">
                                    <i class="fas fa-check"></i>
                                </span>
                                <span class="badge bg-secondary rounded-pill" th:unless="${member?.isActive}">
                                    <i class="fas fa-pause"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tableau performance détaillée -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-table me-2"></i>Performance détaillée de l'équipe
            </h5>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm" onclick="exportTable()">
                    <i class="fas fa-file-excel me-1"></i>Excel
                </button>
                <button class="btn btn-outline-info btn-sm" onclick="printTable()">
                    <i class="fas fa-print me-1"></i>Imprimer
                </button>
            </div>
        </div>
        <div class="card-body">
            <div th:if="${dashboardData?.teamPerformance == null or #lists.isEmpty(dashboardData.teamPerformance)}" class="text-center text-muted py-5">
                <i class="fas fa-chart-bar fa-3x mb-3"></i>
                <h5>Aucune donnée de performance</h5>
                <p class="mb-0">Les données de performance s'afficheront une fois que votre équipe aura des activités.</p>
            </div>

            <div th:if="${dashboardData?.teamPerformance != null and !#lists.isEmpty(dashboardData.teamPerformance)}" class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                    <tr>
                        <th>
                            <i class="fas fa-user me-1"></i>Vendeur
                        </th>
                        <th class="text-end">
                            <i class="fas fa-euro-sign me-1"></i>CA
                        </th>
                        <th class="text-end">
                            <i class="fas fa-bullseye me-1"></i>Objectif
                        </th>
                        <th class="text-center">
                            <i class="fas fa-percentage me-1"></i>Réalisation
                        </th>
                        <th class="text-center">
                            <i class="fas fa-shopping-cart me-1"></i>Commandes
                        </th>
                        <th class="text-center">
                            <i class="fas fa-users me-1"></i>Clients
                        </th>
                        <th class="text-center">Statut</th>
                        <th class="text-center">Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="perf, iterStat : ${dashboardData.teamPerformance}">
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="me-2">
                                    <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 32px; height: 32px;">
                                        <i class="fas fa-user text-primary small"></i>
                                    </div>
                                </div>
                                <div>
                                    <strong th:text="${perf?.name}">Nom</strong>
                                </div>
                            </div>
                        </td>
                        <td class="text-end">
                            <strong th:text="${perf?.revenue ? #numbers.formatCurrency(perf.revenue) : '0 €'}">0 €</strong>
                        </td>
                        <td class="text-end text-muted" th:text="${perf?.target ? #numbers.formatCurrency(perf.target) : '0 €'}">0 €</td>
                        <td class="text-center">
                            <div class="d-flex align-items-center justify-content-center">
                                <div class="progress me-2" style="height: 20px; min-width: 100px;">
                                    <div class="progress-bar fw-bold" role="progressbar"
                                         th:style="'width: ' + ${perf?.achievement ?: 0} + '%'"
                                         th:classappend="${perf?.achievement >= 100} ? 'bg-success' : (${perf?.achievement >= 80} ? 'bg-primary' : (${perf?.achievement >= 50} ? 'bg-warning text-dark' : 'bg-danger'))">
                                        <span th:text="${perf?.achievement ? (#numbers.formatDecimal(perf.achievement, 1, 1) + '%') : '0%'}">0%</span>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-light text-dark" th:text="${perf?.orders ?: 0}">0</span>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-light text-dark" th:text="${perf?.clients ?: 0}">0</span>
                        </td>
                        <td class="text-center">
                                <span class="badge"
                                      th:classappend="'bg-' + (${perf?.achievement >= 100} ? 'success' : (${perf?.achievement >= 80} ? 'primary' : (${perf?.achievement >= 50} ? 'warning' : 'danger')))"
                                      th:text="${perf?.achievement >= 100} ? 'Objectif atteint' : (${perf?.achievement >= 80} ? 'En bonne voie' : (${perf?.achievement >= 50} ? 'À surveiller' : 'En retard'))">
                                    Status
                                </span>
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" th:onclick="'viewDetails(' + ${perf?.userId} + ')'" title="Voir détails">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-success" th:onclick="'setObjective(' + ${perf?.userId} + ')'" title="Définir objectif">
                                    <i class="fas fa-bullseye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript avec Chart.js et fonctionnalités avancées -->
<th:block th:fragment="js_assets">
<script th:inline="javascript">
    // Données depuis le serveur
    const dashboardData = {
        teamPerformance: /*[[${dashboardData?.revenueByTeamMember ?: {}}]]*/ [],
        ordersData: /*[[${dashboardData?.ordersByTeamMember ?: {}}]]*/ [],
        clientsData: /*[[${dashboardData?.clientsByTeamMember ?: {}}]]*/ []
    };

    let currentChart = null;
    let currentDataType = 'revenue';

    document.addEventListener('DOMContentLoaded', function() {
        // Initialiser le graphique
        initializeChart();

        // Initialiser le date range picker
        initializeDateRangePicker();

        // Auto-refresh des données toutes les 5 minutes
        setInterval(refreshData, 300000);

        console.log('Dashboard Manager initialisé');
    });

    function initializeChart() {
        const ctx = document.getElementById('teamPerformanceChart');
        if (!ctx) return;

        const ctxContext = ctx.getContext('2d');

        // Données par défaut si vides
        const defaultData = dashboardData.teamPerformance.length > 0 ? dashboardData.teamPerformance : [
            { name: 'Aucune donnée', revenue: 0, orders: 0, clients: 0 }
        ];

        currentChart = new Chart(ctxContext, {
            type: 'bar',
            data: {
                labels: defaultData.map(item => item.name || 'N/A'),
                datasets: [{
                    label: 'Chiffre d\'affaires (€)',
                    data: defaultData.map(item => item.revenue || 0),
                    backgroundColor: 'rgba(14, 165, 233, 0.8)',
                    borderColor: 'rgba(14, 165, 233, 1)',
                    borderWidth: 2,
                    borderRadius: 4,
                    borderSkipped: false,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: 'rgba(14, 165, 233, 1)',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                if (currentDataType === 'revenue') {
                                    return 'CA: ' + new Intl.NumberFormat('fr-FR', {
                                        style: 'currency',
                                        currency: 'EUR'
                                    }).format(context.parsed.y);
                                }
                                return context.dataset.label + ': ' + context.parsed.y;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            callback: function(value) {
                                if (currentDataType === 'revenue') {
                                    return new Intl.NumberFormat('fr-FR', {
                                        style: 'currency',
                                        currency: 'EUR',
                                        notation: 'compact'
                                    }).format(value);
                                }
                                return value;
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                }
            }
        });
    }

    function switchChart(dataType) {
        if (!currentChart) return;

        // Mettre à jour les boutons actifs
        document.querySelectorAll('.card-header .btn-group button').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        currentDataType = dataType;
        let data, label, color;

        switch(dataType) {
            case 'revenue':
                data = dashboardData.teamPerformance.map(item => item.revenue || 0);
                label = 'Chiffre d\'affaires (€)';
                color = 'rgba(14, 165, 233, 0.8)';
                break;
            case 'orders':
                data = dashboardData.ordersData.length > 0 ?
                    dashboardData.ordersData.map(item => item.orders || 0) :
                    dashboardData.teamPerformance.map(item => item.orders || 0);
                label = 'Nombre de commandes';
                color = 'rgba(16, 185, 129, 0.8)';
                break;
            case 'clients':
                data = dashboardData.clientsData.length > 0 ?
                    dashboardData.clientsData.map(item => item.clients || 0) :
                    dashboardData.teamPerformance.map(item => item.clients || 0);
                label = 'Nombre de clients';
                color = 'rgba(6, 182, 212, 0.8)';
                break;
        }

        currentChart.data.datasets[0].data = data;
        currentChart.data.datasets[0].label = label;
        currentChart.data.datasets[0].backgroundColor = color;
        currentChart.data.datasets[0].borderColor = color.replace('0.8', '1');

        currentChart.update('active');
    }

    function initializeDateRangePicker() {
        $('#dateRangePicker').daterangepicker({
            locale: {
                format: 'DD/MM/YYYY',
                separator: ' - ',
                applyLabel: 'Appliquer',
                cancelLabel: 'Annuler',
                fromLabel: 'De',
                toLabel: 'À',
                customRangeLabel: 'Personnalisé',
                weekLabel: 'S',
                daysOfWeek: ['Di', 'Lu', 'Ma', 'Me', 'Je', 'Ve', 'Sa'],
                monthNames: ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
                    'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'],
                firstDay: 1
            },
            ranges: {
                'Aujourd\'hui': [moment(), moment()],
                'Hier': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                '7 derniers jours': [moment().subtract(6, 'days'), moment()],
                '30 derniers jours': [moment().subtract(29, 'days'), moment()],
                'Ce mois': [moment().startOf('month'), moment().endOf('month')],
                'Mois dernier': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
            }
        }, function(start, end, label) {
            console.log('Nouvelle période sélectionnée: ' + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD'));
            // Rediriger avec les nouvelles dates
            window.location.href = `/dashboard?startDate=${start.format('YYYY-MM-DD')}&endDate=${end.format('YYYY-MM-DD')}`;
        });
    }

    // Fonctions d'actions
    function refreshData() {
        showLoader();
        setTimeout(() => {
            location.reload();
        }, 1000);
    }

    function exportReport() {
        showNotification('Export en cours...', 'info');
        window.open('/manager/export-report?format=excel', '_blank');
    }

    function exportTable() {
        showNotification('Export Excel en cours...', 'info');
        window.open('/manager/export-performance?format=excel', '_blank');
    }

    function printTable() {
        window.print();
    }

    function manageTeam() {
        window.location.href = '/manager/team';
    }

    function viewMemberDetails(memberId) {
        window.location.href = `/users/${memberId}`;
    }

    function contactMember(email) {
        window.location.href = `mailto:${email}?subject=Suivi commercial`;
    }

    function viewDetails(userId) {
        window.location.href = `/manager/member-details/${userId}`;
    }

    function setObjective(userId) {
        // Ouvrir une modal ou rediriger vers la page d'objectifs
        window.location.href = `/manager/set-objective/${userId}`;
    }

    function showLoader() {
        const loader = document.getElementById('chartLoader');
        if (loader) {
            loader.style.display = 'block';
        }
    }

    function showNotification(message, type = 'info') {
        const alertClass = {
            'success': 'alert-success',
            'error': 'alert-danger',
            'warning': 'alert-warning',
            'info': 'alert-info'
        }[type] || 'alert-info';

        const alertDiv = document.createElement('div');
        alertDiv.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 350px;';
        alertDiv.innerHTML = `
            <i class="fas fa-info-circle me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(alertDiv);

        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
</script>
</th:block>

</body>
</html>