<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: layout(~{::title}, ~{::content}, ~{::js_assets})}">
<head>
    <title th:text="|Commande ${order.orderNumber}|">D√©tails Commande</title>
</head>
<body>

<div th:fragment="content" class="order-detail-page">
    <style>
        /* === VARIABLES CSS === */
        .order-detail-page {
            --primary-color: #667eea;
            --primary-light: #764ba2;
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-color: #10b981;
            --success-light: #34d399;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #06b6d4;

            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-md: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);

            --border-radius: 8px;
            --border-radius-lg: 16px;
            --border-radius-xl: 20px;

            min-height: 100vh;
            background-color: var(--gray-50);
            color: var(--gray-900);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
        }

        /* === TYPOGRAPHIE === */
        .order-detail-page h1, .order-detail-page h2, .order-detail-page h3,
        .order-detail-page h4, .order-detail-page h5, .order-detail-page h6 {
            font-weight: 600;
            line-height: 1.3;
            color: var(--gray-900);
        }

        .order-detail-page p {
            color: var(--gray-700);
        }

        /* === HEADER PRINCIPAL === */
        .order-header {
            background-color: #ffffff;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius-xl);
            padding: 2.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .order-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
        }

        .order-number {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 1rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
        }

        .order-status {
            display: inline-flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius-xl);
            font-weight: 600;
            font-size: 0.875rem;
            background: var(--primary-gradient);
            color: white;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .order-status::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .info-item {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--gray-200);
            position: relative;
            transition: all 0.3s ease;
        }

        .info-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
        }

        .info-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-gradient);
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
        }

        .info-label {
            display: flex;
            align-items: center;
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-bottom: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .info-label i {
            margin-right: 0.75rem;
            width: 18px;
            color: var(--primary-color);
            font-size: 1.1em;
        }

        .info-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
            line-height: 1.2;
        }

        .total-amount {
            font-size: 2.5rem;
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.1;
        }

        /* === CARTES DE SECTION === */
        .section-card {
            background-color: #ffffff;
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
            border: 1px solid var(--gray-200);
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .section-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-xl);
        }

        .section-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-color);
        }

        .section-header {
            background-color: #ffffff;
            padding: 2rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }

        .section-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 2rem;
            right: 2rem;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
        }

        .section-title {
            display: flex;
            align-items: center;
            font-size: 1.375rem;
            font-weight: 700;
            color: var(--gray-900);
            margin: 0;
        }

        .section-title i {
            margin-right: 1rem;
            color: var(--primary-color);
            width: 24px;
            font-size: 1.25em;
        }

        .section-content {
            padding: 2rem;
        }

        /* === TABLEAU === */
        .products-table {
            border-radius: var(--border-radius);
            overflow: hidden;
            border: 1px solid var(--gray-200);
        }

        .products-table th {
            background-color: var(--primary-color) !important;
            color: white !important;
            font-weight: 600;
            font-size: 0.875rem;
            padding: 1rem !important;
            border: none !important;
        }

        .products-table td {
            padding: 1rem !important;
            border-bottom: 1px solid var(--gray-200) !important;
            vertical-align: middle;
        }

        .product-row:hover {
            background-color: var(--gray-50) !important;
        }

        .product-info {
            display: flex;
            align-items: center;
        }

        .product-image {
            width: 48px;
            height: 48px;
            background-color: var(--primary-color);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            color: white;
        }

        .product-name {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .product-ref {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        /* === TIMELINE === */
        .timeline {
            position: relative;
            padding-left: 2rem;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0.75rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: var(--gray-300);
        }

        .timeline-item {
            position: relative;
            background-color: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -1.5rem;
            top: 1.25rem;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--gray-300);
            border: 3px solid white;
        }

        .timeline-item.completed::before {
            background-color: var(--success-color);
        }

        .timeline-item h6 {
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        /* === R√âSUM√â FINANCIER === */
        .financial-summary {
            background-color: var(--gray-50);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            border: 1px solid var(--gray-200);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .summary-row:last-child {
            border-bottom: none;
            border-top: 2px solid var(--primary-color);
            margin-top: 1rem;
            padding-top: 1rem;
            font-weight: 700;
            background-color: var(--primary-color);
            color: white;
            margin: 1rem -1.5rem 0;
            padding: 1rem 1.5rem;
        }

        .summary-label {
            color: var(--gray-700);
            font-weight: 500;
        }

        .summary-value {
            font-weight: 600;
            color: var(--gray-900);
        }

        .summary-row:last-child .summary-label,
        .summary-row:last-child .summary-value {
            color: white;
        }

        /* === ADRESSES === */
        .address-card {
            background-color: var(--gray-50);
            border-radius: var(--border-radius);
            padding: 1.25rem;
            border: 1px solid var(--gray-200);
            margin-bottom: 1rem;
        }

        .address-title {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
        }

        .address-title i {
            margin-right: 0.5rem;
            color: var(--primary-color);
        }

        .address-content {
            white-space: pre-line;
            color: var(--gray-700);
            margin: 0;
        }

        /* === BOUTONS === */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .btn-action {
            display: inline-flex;
            align-items: center;
            padding: 0.75rem 1.25rem;
            border-radius: var(--border-radius);
            font-weight: 500;
            text-decoration: none;
            border: 1px solid transparent;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .btn-action i {
            margin-right: 0.5rem;
        }

        .btn-primary-action {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary-action:hover {
            background-color: var(--primary-light);
            color: white;
            text-decoration: none;
        }

        .btn-success-action {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success-action:hover {
            background-color: #047857;
            color: white;
            text-decoration: none;
        }

        .btn-outline-action {
            background-color: white;
            color: var(--gray-700);
            border-color: var(--gray-300);
        }

        .btn-outline-action:hover {
            background-color: var(--gray-50);
            color: var(--gray-900);
            text-decoration: none;
        }

        /* === BADGES === */
        .badge {
            border-radius: var(--border-radius);
            padding: 0.375rem 0.75rem;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .bg-primary {
            background-color: var(--primary-color) !important;
            color: white !important;
        }

        /* === CLIENT INFO === */
        .client-info {
            background-color: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .client-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.75rem;
        }

        .client-detail {
            color: var(--gray-700);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }

        .client-detail i {
            margin-right: 0.5rem;
            color: var(--primary-color);
            width: 16px;
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .order-header {
                padding: 1.5rem;
            }

            .order-number {
                font-size: 2rem;
            }

            .total-amount {
                font-size: 1.5rem;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .section-content {
                padding: 1rem;
            }

            .section-header {
                padding: 1rem;
            }

            .action-buttons {
                justify-content: stretch;
            }

            .btn-action {
                flex: 1;
                justify-content: center;
            }
        }

        /* === IMPRESSION === */
        @media print {
            .action-buttons, .dropdown, .no-print {
                display: none !important;
            }

            .order-detail-page {
                background-color: white !important;
                font-size: 12pt !important;
            }

            .section-card {
                break-inside: avoid;
                box-shadow: none !important;
                border: 1px solid #000 !important;
                background: white !important;
                margin-bottom: 1rem !important;
            }

            .section-header {
                background: #f8f9fa !important;
                border-bottom: 1px solid #000 !important;
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
            }

            .section-title {
                font-size: 14pt !important;
                font-weight: bold !important;
                color: #000 !important;
            }

            .order-header {
                background: white !important;
                border: 2px solid #000 !important;
                padding: 1rem !important;
                margin-bottom: 1rem !important;
            }

            .order-number {
                font-size: 18pt !important;
                font-weight: bold !important;
                color: #000 !important;
                background: none !important;
                -webkit-text-fill-color: unset !important;
            }

            .order-status {
                background: #e9ecef !important;
                color: #000 !important;
                border: 1px solid #000 !important;
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
            }

            .info-item {
                background: white !important;
                border: 1px solid #ccc !important;
                padding: 0.5rem !important;
            }

            .info-label {
                font-weight: bold !important;
                color: #000 !important;
            }

            .info-value, .total-amount {
                color: #000 !important;
                background: none !important;
                -webkit-text-fill-color: unset !important;
                font-weight: bold !important;
            }

            .products-table th {
                background: #e9ecef !important;
                color: #000 !important;
                border: 1px solid #000 !important;
                font-weight: bold !important;
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
            }

            .products-table td {
                color: #000 !important;
                border: 1px solid #000 !important;
                padding: 0.5rem !important;
            }

            .product-name, .product-ref {
                color: #000 !important;
            }

            /* === CORRECTION R√âSUM√â FINANCIER === */
            .financial-summary {
                background: white !important;
                border: 2px solid #000 !important;
                padding: 1rem !important;
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
            }

            .summary-row {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                padding: 0.5rem 0 !important;
                border-bottom: 1px solid #ccc !important;
                color: #000 !important;
            }

            .summary-row:last-child {
                border-bottom: none !important;
                border-top: 2px solid #000 !important;
                margin-top: 0.5rem !important;
                padding-top: 0.75rem !important;
                font-weight: bold !important;
                background: #f8f9fa !important;
                padding: 0.75rem 0 !important;
                margin: 0.5rem 0 0 0 !important;
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
            }

            .summary-label {
                color: #000 !important;
                font-weight: bold !important;
            }

            .summary-value {
                font-weight: bold !important;
                color: #000 !important;
            }

            .summary-row:last-child .summary-label,
            .summary-row:last-child .summary-value {
                color: #000 !important;
                font-weight: bold !important;
            }

            /* Timeline pour impression */
            .timeline-item {
                background: white !important;
                border: 1px solid #ccc !important;
                color: #000 !important;
                margin-bottom: 0.5rem !important;
            }

            .timeline-item h6 {
                color: #000 !important;
            }

            .badge {
                background: #e9ecef !important;
                color: #000 !important;
                border: 1px solid #000 !important;
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
            }

            /* Adresses */
            .address-card, .client-info {
                background: white !important;
                border: 1px solid #ccc !important;
                color: #000 !important;
            }

            .address-title, .client-name {
                color: #000 !important;
                font-weight: bold !important;
            }

            .client-detail {
                color: #000 !important;
            }

            /* Alertes en impression */
            .alert {
                background: white !important;
                border: 2px solid #000 !important;
                color: #000 !important;
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
            }

            /* KPI */
            .kpi-item {
                color: #000 !important;
            }

            .kpi-item i {
                color: #000 !important;
            }

            /* Suppression √©l√©ments non n√©cessaires √† l'impression */
            .btn, .dropdown, .action-buttons, .modal,
            [data-bs-toggle], .progress, button {
                display: none !important;
            }

            /* Forcer la visibilit√© du contenu important */
            .section-content, .financial-summary, .summary-row {
                display: block !important;
                visibility: visible !important;
            }

            /* Pagination forc√©e */
            .section-card {
                page-break-inside: avoid !important;
            }

            .order-header {
                page-break-after: avoid !important;
            }
        }

        /* === COULEURS DE TEXTE === */
        .order-detail-page * {
            color: inherit;
        }

        .order-detail-page .products-table tbody td,
        .order-detail-page .product-name,
        .order-detail-page .section-title {
            color: var(--gray-900) !important;
        }

        .order-detail-page .product-ref {
            color: var(--gray-500) !important;
        }

        .order-detail-page a {
            color: var(--primary-color) !important;
            text-decoration: none;
        }

        .order-detail-page a:hover {
            color: var(--primary-light) !important;
            text-decoration: underline;
        }
    </style>

    <!-- Contenu principal -->
    <!-- Page Header avec actions -->
    <div th:replace="~{fragments/components :: page-header(
        |Commande ${order.orderNumber}|,
        'D√©tails complets de la commande',
        ~{::header-actions})}">
        <div th:fragment="header-actions" class="action-buttons">
            <a th:href="@{/orders}" class="btn-action btn-outline-action">
                <i class="fas fa-arrow-left"></i>
                Retour √† la liste
            </a>
            <div class="dropdown">
                <button class="btn-action btn-outline-action dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-share-alt"></i>
                    Partager
                </button>
                <ul class="dropdown-menu">
                    <li><button class="dropdown-item" onclick="printOrder()">
                        <i class="fas fa-print me-2"></i>Imprimer
                    </button></li>
                    <li><button class="dropdown-item" onclick="downloadPDF()">
                        <i class="fas fa-file-pdf me-2"></i>T√©l√©charger PDF
                    </button></li>
                    <li><button class="dropdown-item" onclick="sendByEmail()">
                        <i class="fas fa-envelope me-2"></i>Envoyer par email
                    </button></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><button class="dropdown-item" onclick="copyOrderLink()">
                        <i class="fas fa-link me-2"></i>Copier le lien
                    </button></li>
                </ul>
            </div>
            <div class="dropdown">
                <button class="btn-action btn-primary-action dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-cogs"></i>
                    Actions
                </button>
                <ul class="dropdown-menu">
                    <li th:if="${order.status.name() == 'BROUILLON' or order.status.name() == 'CONFIRMEE'}">
                        <a class="dropdown-item" th:href="@{/orders/{id}/edit(id=${order.id})}">
                            <i class="fas fa-edit me-2"></i>Modifier
                        </a>
                    </li>
                    <li><button class="dropdown-item" onclick="duplicateOrder()">
                        <i class="fas fa-copy me-2"></i>Dupliquer
                    </button></li>
                    <li><button class="dropdown-item" onclick="addNote()">
                        <i class="fas fa-sticky-note me-2"></i>Ajouter une note
                    </button></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><button class="dropdown-item" onclick="updateStatus()">
                        <i class="fas fa-sync-alt me-2"></i>Changer le statut
                    </button></li>
                    <li th:if="${order.status.name() != 'ANNULEE'}"><button class="dropdown-item text-danger" onclick="cancelOrder()">
                        <i class="fas fa-ban me-2"></i>Annuler la commande
                    </button></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Alertes et notifications -->
    <div th:if="${order.status.name() == 'EN_RETARD' or (order.expectedDeliveryDate != null and order.expectedDeliveryDate.toLocalDate().isBefore(T(java.time.LocalDate).now()) and order.status.name() != 'LIVREE')}" class="alert alert-warning alert-dismissible fade show mb-4" role="alert">
        <div class="d-flex align-items-center">
            <i class="fas fa-exclamation-triangle me-3 fa-2x"></i>
            <div>
                <h5 class="alert-heading mb-1">Attention - Retard de livraison</h5>
                <p class="mb-0">Cette commande devait √™tre livr√©e le <strong th:text="${#temporals.format(order.expectedDeliveryDate.toLocalDate(), 'dd/MM/yyyy')}">date</strong>. Veuillez contacter le client.</p>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${order.paymentStatus.name() == 'OVERDUE'}" class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
        <div class="d-flex align-items-center">
            <i class="fas fa-credit-card me-3 fa-2x"></i>
            <div>
                <h5 class="alert-heading mb-1">Paiement en retard</h5>
                <p class="mb-0">Le paiement de cette commande est en retard. Action requise pour le recouvrement.</p>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- KPI rapides -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-3">
                    <div class="row g-4 text-center">
                        <div class="col-6 col-md-3">
                            <div class="kpi-item">
                                <i class="fas fa-calendar-alt text-primary mb-2 d-block fa-2x"></i>
                                <h6 class="mb-1">D√©lai de traitement</h6>
                                <p class="text-muted small mb-0">
                                    <span th:with="daysBetween=${T(java.time.temporal.ChronoUnit).DAYS.between(order.orderDate.toLocalDate(), T(java.time.LocalDate).now())}"
                                          th:text="${daysBetween}">3</span> jours
                                </p>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="kpi-item">
                                <i class="fas fa-boxes text-info mb-2 d-block fa-2x"></i>
                                <h6 class="mb-1">Articles</h6>
                                <p class="text-muted small mb-0">
                                    <span th:text="${#lists.size(order.orderItems)}">5</span> produits
                                </p>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="kpi-item">
                                <i class="fas fa-percentage text-warning mb-2 d-block fa-2x"></i>
                                <h6 class="mb-1">Marge</h6>
                                <p class="text-muted small mb-0">
                                    <span th:if="${order.marginPercentage != null}" th:text="|${#numbers.formatDecimal(order.marginPercentage, 1, 1)} %|">25.5 %</span>
                                    <span th:unless="${order.marginPercentage != null}">N/A</span>
                                </p>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="kpi-item">
                                <i class="fas fa-star text-success mb-2 d-block fa-2x"></i>
                                <h6 class="mb-1">Priorit√©</h6>
                                <p class="text-muted small mb-0">
                                    <span th:switch="${order.priority != null ? order.priority : 'NORMALE'}"
                                          class="badge rounded-pill">
                                        <span th:case="'HAUTE'" class="bg-danger">Haute</span>
                                        <span th:case="'MOYENNE'" class="bg-warning">Moyenne</span>
                                        <span th:case="*" class="bg-success">Normale</span>
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Header principal de la commande -->
    <div class="order-header">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <div class="order-number" th:text="${order.orderNumber}">CMD-202401-001</div>

                <div class="order-status" th:switch="${order.status.name()}">
                    <span th:case="'BROUILLON'">üìù Brouillon</span>
                    <span th:case="'EN_ATTENTE'">‚è≥ En attente</span>
                    <span th:case="'CONFIRMEE'">‚úÖ Confirm√©e</span>
                    <span th:case="'EN_COURS'">üîÑ En traitement</span>
                    <span th:case="'EXPEDIE'">üöö Exp√©di√©e</span>
                    <span th:case="'LIVREE'">üì¶ Livr√©e</span>
                    <span th:case="'RETOURNEE'">‚Ü©Ô∏è Retourn√©e</span>
                    <span th:case="'ANNULEE'">‚ùå Annul√©e</span>
                    <span th:case="*">‚ùì Statut inconnu</span>
                </div>

                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">
                            <i class="fas fa-calendar-alt"></i>
                            Date de commande
                        </div>
                        <div class="info-value" th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy √† HH:mm')}">
                            01/01/2024 √† 10:00
                        </div>
                    </div>

                    <div class="info-item">
                        <div class="info-label">
                            <i class="fas fa-user-circle"></i>
                            Client
                        </div>
                        <div class="info-value" th:text="${order.client.name}">Nom du Client</div>
                    </div>

                    <div class="info-item" th:if="${order.expectedDeliveryDate}">
                        <div class="info-label">
                            <i class="fas fa-shipping-fast"></i>
                            Livraison pr√©vue
                        </div>
                        <div class="info-value" th:text="${#temporals.format(order.expectedDeliveryDate.toLocalDate(), 'dd/MM/yyyy')}">
                            05/01/2024
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 text-center">
                <div class="info-label">
                    <i class="fas fa-euro-sign"></i>
                    Montant total
                </div>
                <div class="total-amount">
                    <span th:if="${order.totalAmount != null}"
                          th:text="${#numbers.formatCurrency(order.totalAmount)}">1 234,56 ‚Ç¨</span>
                    <span th:unless="${order.totalAmount != null}">
                        <!-- Calcul automatique du total TTC -->
                        <span th:with="calculatedHT=${order.orderItems != null ?
                              #lists.sum(order.orderItems.![totalPriceHT ?: (quantity * unitPrice)]) : 0},
                              totalHT=${calculatedHT - (order.discountAmount ?: 0) + (order.shippingCost ?: 0)},
                              vatAmount=${order.totalVatAmount ?: (totalHT * 0.20)},
                              totalTTC=${totalHT + vatAmount}"
                              th:text="${#numbers.formatCurrency(totalTTC)}">0,00 ‚Ç¨</span>
                    </span>
                </div>
                <div class="mt-3">
                    <span class="badge bg-primary" th:switch="${order.paymentStatus.name()}">
                        <span th:case="'PENDING'">üí∞ Paiement en attente</span>
                        <span th:case="'PARTIAL'">üí≥ Partiellement pay√©</span>
                        <span th:case="'PAID'">‚úÖ Pay√©</span>
                        <span th:case="'OVERDUE'">‚ö†Ô∏è En retard</span>
                        <span th:case="*">‚ùì Statut inconnu</span>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Colonne principale -->
        <div class="col-lg-8">

            <!-- Section des produits -->
            <div class="section-card">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-shopping-cart"></i>
                        Produits command√©s
                    </h3>
                    <span class="badge bg-primary" th:text="|${#lists.size(order.orderItems)} article(s)|">
                        3 articles
                    </span>
                </div>
                <div class="section-content p-0">
                    <div class="table-responsive">
                        <table class="table table-hover products-table mb-0">
                            <thead>
                            <tr class="text-dark-emphasis text-dark" style="color:black">
                                <th style="width: 45%;">Produit</th>
                                <th class="text-center" style="width: 10%; color:black;">Quantit√©</th>
                                <th class="text-end" style="width: 15%;color:black;">Prix unitaire</th>
                                <th class="text-end" style="width: 15%;color:black;">Remise</th>
                                <th class="text-end" style="width: 15%;color:black;">Total HT</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="item : ${order.orderItems}" class="product-row">
                                <td>
                                    <div class="product-info">
                                        <div class="product-image">
                                            <i class="fas fa-cube"></i>
                                        </div>
                                        <div>
                                            <div class="product-name" th:text="${item.product != null ? item.product.name : 'Produit supprim√©'}">
                                                Nom du Produit
                                            </div>
                                            <div class="product-ref" th:text="|R√©f: ${item.product != null ? item.product.reference : 'N/A'}|">
                                                R√©f: REF-001
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center align-middle">
                                    <strong th:text="${item.quantity}">2</strong>
                                </td>
                                <td class="text-end align-middle">
                                    <span th:text="${#numbers.formatCurrency(item.unitPrice)}">99,99 ‚Ç¨</span>
                                </td>
                                <td class="text-end align-middle">
                                        <span th:if="${item.discountRate != null and item.discountRate > 0}"
                                              th:text="|${#numbers.formatDecimal(item.discountRate, 1, 2)} %|">
                                            5,00 %
                                        </span>
                                    <span th:unless="${item.discountRate != null and item.discountRate > 0}">
                                            -
                                        </span>
                                </td>
                                <td class="text-end align-middle">
                                    <strong th:text="${#numbers.formatCurrency(item.totalPriceHT != null ? item.totalPriceHT : 0)}">189,98 ‚Ç¨</strong>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(order.orderItems)}">
                                <td colspan="5" class="text-center text-muted py-5">
                                    <i class="fas fa-shopping-cart fa-3x mb-3 d-block opacity-25"></i>
                                    <strong>Aucun produit dans cette commande</strong>
                                    <p class="mb-0">La commande ne contient aucun article.</p>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Section historique/timeline -->
            <div class="section-card">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-route"></i>
                        Suivi de la commande
                    </h3>
                    <div class="progress" style="height: 8px; width: 200px;">
                        <div class="progress-bar bg-primary" role="progressbar"
                             th:style="|width: ${(order.status.name() == 'BROUILLON' ? 10 :
                                                 order.status.name() == 'CONFIRMEE' ? 25 :
                                                 order.status.name() == 'EN_COURS' ? 50 :
                                                 order.status.name() == 'EXPEDIE' ? 75 :
                                                 order.status.name() == 'LIVREE' ? 100 : 10)}%|"
                             aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
                <div class="section-content">
                    <div class="timeline">
                        <div class="timeline-item completed">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-2">üéØ Commande cr√©√©e</h6>
                                    <p class="mb-2 text-muted" th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy √† HH:mm')}">
                                        01/01/2024 √† 10:00
                                    </p>
                                    <p class="mb-0 small">
                                        Par <strong th:text="${order.user?.firstName + ' ' + order.user?.lastName ?: 'Syst√®me'}">Jean Dupont</strong>
                                    </p>
                                </div>
                                <span class="badge bg-success">Termin√©</span>
                            </div>
                        </div>

                        <div class="timeline-item"
                             th:class="${order.status.name() == 'CONFIRMEE' or order.status.name() == 'EN_COURS' or order.status.name() == 'EXPEDIE' or order.status.name() == 'LIVREE'} ? 'timeline-item completed' : 'timeline-item'">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-2">‚úÖ Commande confirm√©e</h6>
                                    <p class="mb-2 text-muted">
                                        <span th:if="${order.status.name() == 'CONFIRMEE' or order.status.name() == 'EN_COURS' or order.status.name() == 'EXPEDIE' or order.status.name() == 'LIVREE'}">
                                            <span th:text="${order.confirmedAt != null ? #temporals.format(order.confirmedAt, 'dd/MM/yyyy √† HH:mm') : 'Confirm√©'}">02/01/2024 √† 09:15</span>
                                        </span>
                                        <span th:unless="${order.status.name() == 'CONFIRMEE' or order.status.name() == 'EN_COURS' or order.status.name() == 'EXPEDIE' or order.status.name() == 'LIVREE'}">
                                            En attente de confirmation
                                        </span>
                                    </p>
                                    <p class="mb-0 small">
                                        <span th:if="${order.status.name() == 'CONFIRMEE' or order.status.name() == 'EN_COURS' or order.status.name() == 'EXPEDIE' or order.status.name() == 'LIVREE'}">
                                            Commande valid√©e et pr√™te pour traitement
                                        </span>
                                    </p>
                                </div>
                                <span th:if="${order.status.name() == 'CONFIRMEE' or order.status.name() == 'EN_COURS' or order.status.name() == 'EXPEDIE' or order.status.name() == 'LIVREE'}"
                                      class="badge bg-success">Termin√©</span>
                                <span th:unless="${order.status.name() == 'CONFIRMEE' or order.status.name() == 'EN_COURS' or order.status.name() == 'EXPEDIE' or order.status.name() == 'LIVREE'}"
                                      class="badge bg-warning">En attente</span>
                            </div>
                        </div>

                        <div class="timeline-item"
                             th:class="${order.status.name() == 'EN_COURS' or order.status.name() == 'EXPEDIE' or order.status.name() == 'LIVREE'} ? 'timeline-item completed' : 'timeline-item'">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-2">üîÑ En cours de traitement</h6>
                                    <p class="mb-2 text-muted">
                                        <span th:if="${order.status.name() == 'EN_COURS' or order.status.name() == 'EXPEDIE' or order.status.name() == 'LIVREE'}">
                                            Pr√©paration en cours
                                        </span>
                                        <span th:unless="${order.status.name() == 'EN_COURS' or order.status.name() == 'EXPEDIE' or order.status.name() == 'LIVREE'}">
                                            En attente de traitement
                                        </span>
                                    </p>
                                    <div th:if="${order.status.name() == 'EN_COURS'}" class="small text-info">
                                        <i class="fas fa-clock me-1"></i>Temps estim√© : 2-3 jours ouvr√©s
                                    </div>
                                </div>
                                <span th:if="${order.status.name() == 'EN_COURS' or order.status.name() == 'EXPEDIE' or order.status.name() == 'LIVREE'}"
                                      class="badge bg-success">Termin√©</span>
                                <span th:unless="${order.status.name() == 'EN_COURS' or order.status.name() == 'EXPEDIE' or order.status.name() == 'LIVREE'}"
                                      class="badge bg-secondary">En attente</span>
                            </div>
                        </div>

                        <div class="timeline-item"
                             th:class="${order.status.name() == 'EXPEDIE' or order.status.name() == 'LIVREE'} ? 'timeline-item completed' : 'timeline-item'">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-2">üöö Exp√©di√©e</h6>
                                    <div th:if="${order.status.name() == 'EXPEDIE' or order.status.name() == 'LIVREE'}">
                                        <p class="mb-2 text-muted">
                                            <span th:text="${order.shippedAt != null ? #temporals.format(order.shippedAt, 'dd/MM/yyyy √† HH:mm') : 'Exp√©di√©e'}">03/01/2024 √† 14:30</span>
                                        </p>
                                        <div class="small">
                                            <div class="mb-1">
                                                <i class="fas fa-truck me-1 text-primary"></i>
                                                Transporteur : <strong th:text="${order.carrier ?: 'Colissimo'}">Colissimo</strong>
                                            </div>
                                            <div th:if="${order.trackingNumber}">
                                                <i class="fas fa-barcode me-1 text-primary"></i>
                                                Suivi : <a th:text="${order.trackingNumber}" href="#" class="fw-bold">1Z999AA1234567890</a>
                                                <button class="btn btn-sm btn-link p-0 ms-2" onclick="copyTrackingNumber()">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <p th:unless="${order.status.name() == 'EXPEDIE' or order.status.name() == 'LIVREE'}" class="mb-0 text-muted small">
                                        En attente d'exp√©dition
                                    </p>
                                </div>
                                <span th:if="${order.status.name() == 'EXPEDIE' or order.status.name() == 'LIVREE'}"
                                      class="badge bg-success">Termin√©</span>
                                <span th:unless="${order.status.name() == 'EXPEDIE' or order.status.name() == 'LIVREE'}"
                                      class="badge bg-secondary">En attente</span>
                            </div>
                        </div>

                        <div class="timeline-item"
                             th:class="${order.status.name() == 'LIVREE'} ? 'timeline-item completed' : 'timeline-item'">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-2">üì¶ Livr√©e</h6>
                                    <div th:if="${order.status.name() == 'LIVREE'}">
                                        <p class="mb-2 text-muted">
                                            <span th:text="${order.deliveredAt != null ? #temporals.format(order.deliveredAt, 'dd/MM/yyyy √† HH:mm') : 'Livr√©e'}">05/01/2024 √† 16:45</span>
                                        </p>
                                        <div class="small text-success">
                                            <i class="fas fa-check-circle me-1"></i>Livraison confirm√©e
                                            <span th:if="${order.deliverySignature}"> - Sign√© par : <strong th:text="${order.deliverySignature}">M. Dupont</strong></span>
                                        </div>
                                    </div>
                                    <p th:unless="${order.status.name() == 'LIVREE'}" class="mb-0 text-muted small">
                                        Livraison pr√©vue le <span th:text="${order.expectedDeliveryDate != null ? #temporals.format(order.expectedDeliveryDate.toLocalDate(), 'dd/MM/yyyy') : '√Ä d√©finir'}">05/01/2024</span>
                                    </p>
                                </div>
                                <span th:if="${order.status.name() == 'LIVREE'}"
                                      class="badge bg-success">Termin√©</span>
                                <span th:unless="${order.status.name() == 'LIVREE'}"
                                      class="badge bg-secondary">En attente</span>
                            </div>
                        </div>
                    </div>

                    <!-- Actions sur le suivi -->
                    <div class="mt-4 pt-3 border-top">
                        <div class="d-flex flex-wrap gap-2">
                            <button th:if="${order.status.name() == 'EXPEDIE'}" class="btn btn-sm btn-outline-primary" onclick="refreshTracking()">
                                <i class="fas fa-sync-alt me-1"></i>Actualiser le suivi
                            </button>
                            <button th:if="${order.status.name() != 'LIVREE'}" class="btn btn-sm btn-outline-success" onclick="notifyClient()">
                                <i class="fas fa-bell me-1"></i>Notifier le client
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="addTrackingNote()">
                                <i class="fas fa-plus me-1"></i>Ajouter une note
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Colonne lat√©rale -->
        <div class="col-lg-4">

            <!-- Informations client -->
            <div class="section-card">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-user-circle"></i>
                        Client
                    </h3>
                </div>
                <div class="section-content">
                    <div class="client-info">
                        <h5 class="client-name" th:text="${order.client.name}">Nom du Client</h5>
                        <div class="client-detail" th:if="${order.client.companyName}">
                            <i class="fas fa-building"></i>
                            <span th:text="${order.client.companyName}">Nom de l'entreprise</span>
                        </div>
                        <div class="client-detail">
                            <i class="fas fa-envelope"></i>
                            <a th:href="|mailto:${order.client.email}|" th:text="${order.client.email}">email@client.com</a>
                        </div>
                        <div class="client-detail" th:if="${order.client.phoneNumber}">
                            <i class="fas fa-phone"></i>
                            <a th:href="|tel:${order.client.phoneNumber}|" th:text="${order.client.phoneNumber}">+33 1 23 45 67 89</a>
                        </div>
                    </div>
                    <div class="mt-3">
                        <a th:href="@{/clients/{id}(id=${order.client.id})}" class="btn-action btn-outline-action">
                            <i class="fas fa-eye"></i>
                            Voir la fiche
                        </a>
                    </div>
                </div>
            </div>

            <!-- Adresses -->
            <div class="section-card">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-map-marker-alt"></i>
                        Adresses
                    </h3>
                </div>
                <div class="section-content">
                    <div class="address-card">
                        <div class="address-title">
                            <i class="fas fa-file-invoice"></i>
                            Facturation
                        </div>
                        <div class="address-content" th:text="${order.billingAddress ?: 'Adresse non sp√©cifi√©e'}">
                            123 Rue de la Facture
                            75001 Paris, France
                        </div>
                    </div>

                    <div class="address-card">
                        <div class="address-title">
                            <i class="fas fa-shipping-fast"></i>
                            Livraison
                        </div>
                        <div class="address-content" th:text="${order.shippingAddress ?: 'Adresse non sp√©cifi√©e'}">
                            456 Avenue de la Livraison
                            75002 Paris, France
                        </div>
                    </div>
                </div>
            </div>

            <!-- R√©sum√© financier -->
            <div class="section-card">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-calculator"></i>
                        R√©sum√© financier
                    </h3>
                </div>
                <div class="section-content">
                    <div class="financial-summary">
                        <!-- Calcul dynamique du sous-total HT -->
                        <div class="summary-row">
                            <span class="summary-label">Sous-total HT :</span>
                            <span class="summary-value">
                                <span th:if="${order.totalAmountHT != null}"
                                      th:text="${#numbers.formatCurrency(order.totalAmountHT)}">1 000,00 ‚Ç¨</span>
                                <span th:unless="${order.totalAmountHT != null}">
                                    <!-- Calcul automatique si pas d√©fini -->
                                    <span th:with="calculatedHT=${order.orderItems != null ?
                                          #lists.sum(order.orderItems.![totalPriceHT ?: (quantity * unitPrice)]) : 0}"
                                          th:text="${#numbers.formatCurrency(calculatedHT)}">0,00 ‚Ç¨</span>
                                </span>
                            </span>
                        </div>

                        <!-- Remise si applicable -->
                        <div class="summary-row" th:if="${order.discountAmount != null and order.discountAmount > 0}">
                            <span class="summary-label">Remise :</span>
                            <span class="summary-value text-danger">
                                -<span th:text="${#numbers.formatCurrency(order.discountAmount)}">50,00 ‚Ç¨</span>
                            </span>
                        </div>

                        <!-- Sous-total apr√®s remise -->
                        <div class="summary-row" th:if="${order.discountAmount != null and order.discountAmount > 0}">
                            <span class="summary-label">Sous-total apr√®s remise :</span>
                            <span class="summary-value">
                                <span th:with="subtotalAfterDiscount=${(order.totalAmountHT ?:
                                      (order.orderItems != null ? #lists.sum(order.orderItems.![totalPriceHT ?: (quantity * unitPrice)]) : 0))
                                      - (order.discountAmount ?: 0)}"
                                      th:text="${#numbers.formatCurrency(subtotalAfterDiscount)}">950,00 ‚Ç¨</span>
                            </span>
                        </div>

                        <!-- Frais de port -->
                        <div class="summary-row" th:if="${order.shippingCost != null and order.shippingCost > 0}">
                            <span class="summary-label">Frais de port HT :</span>
                            <span class="summary-value" th:text="${#numbers.formatCurrency(order.shippingCost)}">15,00 ‚Ç¨</span>
                        </div>

                        <!-- Total HT final -->
                        <div class="summary-row">
                            <span class="summary-label">Total HT :</span>
                            <span class="summary-value">
                                <span th:with="totalHT=${(order.totalAmountHT ?:
                                      (order.orderItems != null ? #lists.sum(order.orderItems.![totalPriceHT ?: (quantity * unitPrice)]) : 0))
                                      - (order.discountAmount ?: 0) + (order.shippingCost ?: 0)}"
                                      th:text="${#numbers.formatCurrency(totalHT)}">965,00 ‚Ç¨</span>
                            </span>
                        </div>

                        <!-- TVA calcul√©e -->
                        <div class="summary-row">
                            <span class="summary-label">TVA (20%) :</span>
                            <span class="summary-value">
                                <span th:if="${order.totalVatAmount != null}"
                                      th:text="${#numbers.formatCurrency(order.totalVatAmount)}">200,00 ‚Ç¨</span>
                                <span th:unless="${order.totalVatAmount != null}">
                                    <!-- Calcul automatique TVA 20% -->
                                    <span th:with="totalHT=${(order.totalAmountHT ?:
                                          (order.orderItems != null ? #lists.sum(order.orderItems.![totalPriceHT ?: (quantity * unitPrice)]) : 0))
                                          - (order.discountAmount ?: 0) + (order.shippingCost ?: 0)},
                                          calculatedVAT=${totalHT * 0.20}"
                                          th:text="${#numbers.formatCurrency(calculatedVAT)}">193,00 ‚Ç¨</span>
                                </span>
                            </span>
                        </div>

                        <!-- Total TTC final -->
                        <div class="summary-row">
                            <span class="summary-label">TOTAL TTC :</span>
                            <span class="summary-value">
                                <span th:if="${order.totalAmount != null}"
                                      th:text="${#numbers.formatCurrency(order.totalAmount)}">1 234,56 ‚Ç¨</span>
                                <span th:unless="${order.totalAmount != null}">
                                    <!-- Calcul automatique TTC -->
                                    <span th:with="totalHT=${(order.totalAmountHT ?:
                                          (order.orderItems != null ? #lists.sum(order.orderItems.![totalPriceHT ?: (quantity * unitPrice)]) : 0))
                                          - (order.discountAmount ?: 0) + (order.shippingCost ?: 0)},
                                          vatAmount=${order.totalVatAmount ?: (totalHT * 0.20)},
                                          totalTTC=${totalHT + vatAmount}"
                                          th:text="${#numbers.formatCurrency(totalTTC)}">1 158,00 ‚Ç¨</span>
                                </span>
                            </span>
                        </div>
                    </div>

                    <!-- Note explicative sur les calculs -->
                    <div class="mt-3 p-3 bg-light border-start border-primary border-4 small">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-info-circle text-primary me-2 mt-1"></i>
                            <div>
                                <strong>Calcul des montants :</strong>
                                <ul class="mb-0 mt-1 ps-3">
                                    <li>Le sous-total HT est calcul√© √† partir du total des lignes de commande</li>
                                    <li>Les remises sont d√©duites du sous-total HT</li>
                                    <li>La TVA est calcul√©e sur le total HT apr√®s remises (taux standard : 20%)</li>
                                    <li>Le total TTC inclut la TVA et les frais de port √©ventuels</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Actions de facturation -->
                    <div class="mt-4">
                        <div class="d-grid gap-2">
                            <!-- Bouton de g√©n√©ration de facture - M√©thode GET (formulaire) -->
                            <a th:href="@{/invoices/new(orderId=${order.id})}"
                               th:if="${canInvoice}"
                               class="btn-action btn-primary-action w-100 text-center">
                                <i class="fas fa-file-invoice-dollar"></i>
                                Cr√©er une facture
                            </a>

                            <!-- Bouton de g√©n√©ration rapide - M√©thode POST (direct) -->
                            <form th:if="${canInvoice}" th:action="@{/orders/{id}/create-invoice(id=${order.id})}" method="post" class="mt-2">
                                <button type="submit" class="btn-action btn-success-action w-100"
                                        onclick="return confirm('Cr√©er une facture automatiquement √† partir de cette commande ?')">
                                    <i class="fas fa-bolt"></i>
                                    Facture automatique
                                </button>
                            </form>

                            <a th:href="@{/invoices/{id}(id=${order.invoice.id})}"
                               th:if="${order.invoice != null}"
                               class="btn-action btn-outline-success w-100 text-center">
                                <i class="fas fa-file-invoice"></i>
                                Voir la facture
                            </a>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Section des notes -->
    <div class="row" th:if="${(order.notes != null and !#strings.isEmpty(order.notes)) or (order.internalNotes != null and !#strings.isEmpty(order.internalNotes))}">
        <div class="col-12">
            <div class="section-card">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-sticky-note"></i>
                        Notes
                    </h3>
                </div>
                <div class="section-content">
                    <div class="row">
                        <div class="col-md-6" th:if="${order.notes}">
                            <div class="address-card">
                                <h6 class="address-title">
                                    <i class="fas fa-comment"></i>
                                    Notes client
                                </h6>
                                <p class="mb-0" th:text="${order.notes}">Notes visibles par le client</p>
                            </div>
                        </div>
                        <div class="col-md-6" th:if="${order.internalNotes}">
                            <div class="address-card">
                                <h6 class="address-title">
                                    <i class="fas fa-lock"></i>
                                    Notes internes
                                </h6>
                                <p class="mb-0" th:text="${order.internalNotes}">Notes internes uniquement</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<th:block th:fragment="js_assets">
    <script>
        // === VARIABLES GLOBALES ===
        const orderData = {
            id: /*[[${order.id}]]*/ 1,
            number: /*[[${order.orderNumber}]]*/ 'CMD-001',
            clientEmail: /*[[${order.client.email}]]*/ 'client@example.com',
            clientName: /*[[${order.client.name}]]*/ 'Client Test',
            status: /*[[${order.status.name()}]]*/ 'CONFIRMEE',
            trackingNumber: /*[[${order.trackingNumber}]]*/ null
        };

        // === FONCTIONS AVANC√âES ===
        function printOrder() {
            // Pr√©paration pour l'impression avec des styles optimis√©s
            const printContent = document.querySelector('.order-detail-page').innerHTML;
            const printWindow = window.open('', '_blank');

            // Cr√©ation du contenu HTML sans template literals
            let htmlContent = '<html><head>';
            htmlContent += '<title>Commande ' + orderData.number + '</title>';
            htmlContent += '<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">';
            htmlContent += '<style>';
            htmlContent += 'body { font-family: Arial, sans-serif; font-size: 12pt; color: #000; }';
            htmlContent += '@media print {';
            htmlContent += '.no-print, .dropdown, .btn, button, .action-buttons, .modal, .progress, .alert { display: none !important; }';
            htmlContent += '.section-card { break-inside: avoid; border: 1px solid #000; margin-bottom: 1rem; background: white; }';
            htmlContent += '.financial-summary { border: 2px solid #000 !important; background: white !important; padding: 1rem !important; }';
            htmlContent += '.summary-row { display: flex !important; justify-content: space-between !important; padding: 0.5rem 0 !important; border-bottom: 1px solid #ccc !important; color: #000 !important; }';
            htmlContent += '.summary-row:last-child { border-top: 2px solid #000 !important; font-weight: bold !important; background: #f8f9fa !important; margin-top: 0.5rem !important; padding: 0.75rem 0 !important; }';
            htmlContent += '.summary-label, .summary-value { color: #000 !important; }';
            htmlContent += '.order-number { color: #000 !important; background: none !important; -webkit-text-fill-color: unset !important; }';
            htmlContent += '.total-amount { color: #000 !important; background: none !important; -webkit-text-fill-color: unset !important; }';
            htmlContent += '.products-table th { background: #e9ecef !important; color: #000 !important; border: 1px solid #000 !important; }';
            htmlContent += '.products-table td { color: #000 !important; border: 1px solid #000 !important; }';
            htmlContent += '* { color: #000 !important; print-color-adjust: exact !important; -webkit-print-color-adjust: exact !important; }';
            htmlContent += '}';
            htmlContent += '</style>';
            htmlContent += '</head>';
            htmlContent += '<body class="p-3">';
            htmlContent += printContent;
            htmlContent += '<script>';
            htmlContent += 'window.onload = function() { setTimeout(function() { window.print(); window.close(); }, 500); }';
            htmlContent += '<\/script>';
            htmlContent += '</body></html>';

            printWindow.document.write(htmlContent);
            printWindow.document.close();
        }

        function downloadPDF() {
            GlobalLoadingManager.show('G√©n√©ration du PDF...');

            fetch('/orders/' + orderData.id + '/pdf', {
                method: 'GET',
                headers: {
                    'Accept': 'application/pdf'
                }
            })
                .then(response => {
                    if (!response.ok) throw new Error('Erreur lors de la g√©n√©ration');
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'Commande-' + orderData.number + '.pdf';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    GlobalLoadingManager.hide();
                    showNotification('PDF t√©l√©charg√© avec succ√®s', 'success');
                })
                .catch(error => {
                    GlobalLoadingManager.hide();
                    showNotification('Erreur lors du t√©l√©chargement : ' + error.message, 'error');
                });
        }

        function sendByEmail() {
            showEmailModal();
        }

        function copyOrderLink() {
            const orderUrl = window.location.href;
            navigator.clipboard.writeText(orderUrl).then(() => {
                showNotification('Lien copi√© dans le presse-papiers', 'success');
            }).catch(() => {
                showNotification('Erreur lors de la copie', 'error');
            });
        }

        function duplicateOrder() {
            if (confirm('Cr√©er une nouvelle commande bas√©e sur ' + orderData.number + ' ?')) {
                GlobalLoadingManager.show('Duplication en cours...');

                fetch('/orders/' + orderData.id + '/duplicate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        GlobalLoadingManager.hide();
                        if (data.success) {
                            showNotification('Commande dupliqu√©e avec succ√®s', 'success');
                            setTimeout(() => {
                                window.location.href = '/orders/' + data.newOrderId;
                            }, 1000);
                        } else {
                            showNotification('Erreur lors de la duplication', 'error');
                        }
                    })
                    .catch(error => {
                        GlobalLoadingManager.hide();
                        showNotification('Erreur lors de la duplication', 'error');
                    });
            }
        }

        function updateStatus() {
            showStatusModal();
        }

        function cancelOrder() {
            showCancelModal();
        }

        function addNote() {
            showNoteModal();
        }

        function copyTrackingNumber() {
            if (orderData.trackingNumber) {
                navigator.clipboard.writeText(orderData.trackingNumber).then(() => {
                    showNotification('Num√©ro de suivi copi√©', 'success');
                });
            }
        }

        function refreshTracking() {
            GlobalLoadingManager.show('Actualisation du suivi...');

            fetch('/orders/' + orderData.id + '/tracking/refresh', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    GlobalLoadingManager.hide();
                    if (data.success) {
                        showNotification('Informations de suivi mises √† jour', 'success');
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        showNotification('Aucune nouvelle information de suivi', 'info');
                    }
                })
                .catch(error => {
                    GlobalLoadingManager.hide();
                    showNotification('Erreur lors de l\'actualisation', 'error');
                });
        }

        function notifyClient() {
            showClientNotificationModal();
        }

        function addTrackingNote() {
            showTrackingNoteModal();
        }

        // === MODALS ===
        function showEmailModal() {
            let modalHtml = '<div class="modal fade" id="emailModal" tabindex="-1">';
            modalHtml += '<div class="modal-dialog"><div class="modal-content">';
            modalHtml += '<div class="modal-header">';
            modalHtml += '<h5 class="modal-title"><i class="fas fa-envelope me-2"></i>Envoyer par email</h5>';
            modalHtml += '<button type="button" class="btn-close" data-bs-dismiss="modal"></button>';
            modalHtml += '</div>';
            modalHtml += '<div class="modal-body"><form id="emailForm">';
            modalHtml += '<div class="mb-3"><label for="emailTo" class="form-label">Destinataire</label>';
            modalHtml += '<input type="email" class="form-control" id="emailTo" value="' + (orderData.clientEmail || '') + '" required></div>';
            modalHtml += '<div class="mb-3"><label for="emailCc" class="form-label">Copie (optionnel)</label>';
            modalHtml += '<input type="email" class="form-control" id="emailCc" placeholder="email@exemple.com"></div>';
            modalHtml += '<div class="mb-3"><label for="emailSubject" class="form-label">Objet</label>';
            modalHtml += '<input type="text" class="form-control" id="emailSubject" value="Commande ' + (orderData.number || '') + ' - D√©tails" required></div>';
            modalHtml += '<div class="mb-3"><label for="emailMessage" class="form-label">Message personnalis√©</label>';
            modalHtml += '<textarea class="form-control" id="emailMessage" rows="4" placeholder="Message optionnel..."></textarea></div>';
            modalHtml += '<div class="form-check">';
            modalHtml += '<input class="form-check-input" type="checkbox" id="attachPDF" checked>';
            modalHtml += '<label class="form-check-label" for="attachPDF">Joindre le PDF de la commande</label>';
            modalHtml += '</div></form></div>';
            modalHtml += '<div class="modal-footer">';
            modalHtml += '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>';
            modalHtml += '<button type="button" class="btn btn-primary" onclick="sendEmail()"><i class="fas fa-paper-plane me-2"></i>Envoyer</button>';
            modalHtml += '</div></div></div></div>';

            showModal(modalHtml, 'emailModal');
        }

        function showStatusModal() {
            const statusOptions = [
                { value: 'BROUILLON', label: 'üìù Brouillon', color: 'secondary' },
                { value: 'CONFIRMEE', label: '‚úÖ Confirm√©e', color: 'success' },
                { value: 'EN_COURS', label: 'üîÑ En cours', color: 'info' },
                { value: 'EXPEDIE', label: 'üöö Exp√©di√©e', color: 'primary' },
                { value: 'LIVREE', label: 'üì¶ Livr√©e', color: 'success' },
                { value: 'ANNULEE', label: '‚ùå Annul√©e', color: 'danger' }
            ];

            let optionsHtml = '';
            statusOptions.forEach(function(option) {
                const selected = option.value === (orderData.status || '') ? ' selected' : '';
                optionsHtml += '<option value="' + option.value + '" ' + selected + '>' + option.label + '</option>';
            });

            let modalHtml = '<div class="modal fade" id="statusModal" tabindex="-1">';
            modalHtml += '<div class="modal-dialog"><div class="modal-content">';
            modalHtml += '<div class="modal-header">';
            modalHtml += '<h5 class="modal-title"><i class="fas fa-sync-alt me-2"></i>Changer le statut</h5>';
            modalHtml += '<button type="button" class="btn-close" data-bs-dismiss="modal"></button>';
            modalHtml += '</div>';
            modalHtml += '<div class="modal-body"><form id="statusForm">';
            modalHtml += '<div class="mb-3"><label for="newStatus" class="form-label">Nouveau statut</label>';
            modalHtml += '<select class="form-select" id="newStatus" required>' + optionsHtml + '</select></div>';
            modalHtml += '<div class="mb-3"><label for="statusComment" class="form-label">Commentaire (optionnel)</label>';
            modalHtml += '<textarea class="form-control" id="statusComment" rows="3" placeholder="Raison du changement de statut..."></textarea></div>';
            modalHtml += '<div class="form-check">';
            modalHtml += '<input class="form-check-input" type="checkbox" id="notifyStatusChange" checked>';
            modalHtml += '<label class="form-check-label" for="notifyStatusChange">Notifier le client par email</label>';
            modalHtml += '</div></form></div>';
            modalHtml += '<div class="modal-footer">';
            modalHtml += '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>';
            modalHtml += '<button type="button" class="btn btn-primary" onclick="saveStatusChange()"><i class="fas fa-check me-2"></i>Confirmer</button>';
            modalHtml += '</div></div></div></div>';

            showModal(modalHtml, 'statusModal');
        }

        function sendEmail() {
            const formData = {
                to: document.getElementById('emailTo').value,
                cc: document.getElementById('emailCc').value,
                subject: document.getElementById('emailSubject').value,
                message: document.getElementById('emailMessage').value,
                attachPDF: document.getElementById('attachPDF').checked
            };

            GlobalLoadingManager.show('Envoi en cours...');

            fetch('/orders/' + orderData.id + '/email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(formData)
            })
                .then(response => response.json())
                .then(data => {
                    GlobalLoadingManager.hide();
                    hideModal('emailModal');
                    if (data.success) {
                        showNotification('Email envoy√© avec succ√®s', 'success');
                    } else {
                        showNotification('Erreur lors de l\'envoi : ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    GlobalLoadingManager.hide();
                    hideModal('emailModal');
                    showNotification('Erreur lors de l\'envoi', 'error');
                });
        }

        function saveStatusChange() {
            const newStatus = document.getElementById('newStatus').value;
            const comment = document.getElementById('statusComment').value;
            const notify = document.getElementById('notifyStatusChange').checked;

            GlobalLoadingManager.show('Mise √† jour...');

            fetch('/orders/' + orderData.id + '/status', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    status: newStatus,
                    comment: comment,
                    notifyClient: notify
                })
            })
                .then(response => response.json())
                .then(data => {
                    GlobalLoadingManager.hide();
                    hideModal('statusModal');
                    if (data.success) {
                        showNotification('Statut mis √† jour avec succ√®s', 'success');
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        showNotification('Erreur lors de la mise √† jour', 'error');
                    }
                })
                .catch(error => {
                    GlobalLoadingManager.hide();
                    hideModal('statusModal');
                    showNotification('Erreur lors de la mise √† jour', 'error');
                });
        }

        // === UTILITAIRES ===
        function showModal(htmlContent, modalId) {
            // Supprimer l'ancien modal s'il existe
            const existingModal = document.getElementById(modalId);
            if (existingModal) {
                existingModal.remove();
            }

            // Ajouter le nouveau modal
            document.body.insertAdjacentHTML('beforeend', htmlContent);
            const modal = new bootstrap.Modal(document.getElementById(modalId));
            modal.show();
        }

        function hideModal(modalId) {
            const modal = bootstrap.Modal.getInstance(document.getElementById(modalId));
            if (modal) {
                modal.hide();
            }
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-success',
                error: 'bg-danger',
                warning: 'bg-warning',
                info: 'bg-info'
            };

            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-triangle',
                warning: 'fas fa-exclamation-circle',
                info: 'fas fa-info-circle'
            };

            const toast = document.createElement('div');
            toast.className = 'toast align-items-center text-white ' + colors[type] + ' border-0';
            toast.setAttribute('role', 'alert');
            toast.innerHTML = '<div class="d-flex"><div class="toast-body"><i class="' + icons[type] + ' me-2"></i>' + message + '</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>';

            // Ajouter le toast au container
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '9999';
                document.body.appendChild(toastContainer);
            }

            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();

            // Supprimer le toast apr√®s fermeture
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        // === INITIALISATION AVANC√âE ===
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page de d√©tail de commande charg√©e - Version professionnelle');

            // Animation d'entr√©e pour les √©l√©ments
            animateElements();

            // Initialisation des tooltips
            initializeTooltips();

            // Auto-refresh pour les commandes en cours
            if (orderData.status === 'EXPEDIE' || orderData.status === 'EN_COURS') {
                setupAutoRefresh();
            }

            // Raccourcis clavier
            setupKeyboardShortcuts();
        });

        function animateElements() {
            const elements = document.querySelectorAll('.section-card, .info-item');
            elements.forEach((element, index) => {
                element.style.opacity = '0';
                element.style.transform = 'translateY(20px)';

                setTimeout(() => {
                    element.style.transition = 'all 0.6s ease-out';
                    element.style.opacity = '1';
                    element.style.transform = 'translateY(0)';
                }, index * 100);
            });
        }

        function initializeTooltips() {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }

        function setupAutoRefresh() {
            // Actualisation automatique toutes les 5 minutes pour les commandes actives
            setInterval(() => {
                if (document.visibilityState === 'visible') {
                    refreshOrderData();
                }
            }, 300000); // 5 minutes
        }

        function refreshOrderData() {
            fetch('/orders/' + orderData.id + '/status', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.statusChanged) {
                        showNotification('Le statut de la commande a √©t√© mis √† jour', 'info');
                        setTimeout(() => window.location.reload(), 2000);
                    }
                })
                .catch(error => {
                    console.log('Erreur lors de l\'actualisation automatique:', error);
                });
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl+P : Imprimer
                if (e.ctrlKey && e.key === 'p') {
                    e.preventDefault();
                    printOrder();
                }

                // Ctrl+E : Envoyer par email
                if (e.ctrlKey && e.key === 'e') {
                    e.preventDefault();
                    sendByEmail();
                }

                // Ctrl+D : Dupliquer
                if (e.ctrlKey && e.key === 'd') {
                    e.preventDefault();
                    duplicateOrder();
                }
            });
        }
    </script>
</th:block>

</body>
</html>
