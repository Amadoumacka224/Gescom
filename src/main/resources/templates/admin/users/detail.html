<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: layout(~{::title}, ~{::content}, ~{::js_assets})}">
<head>
    <title th:text="'Détails - ' + ${user?.fullName ?: 'Utilisateur'}">Détails de l'Utilisateur</title>
</head>
<body>
<style>
    @media print {
        .btn, .dropdown, nav, .card-header .btn, .modal {
            display: none !important;
        }

        .card {
            border: 1px solid #dee2e6 !important;
            box-shadow: none !important;
        }
    }

    .progress {
        background-color: #e9ecef;
    }

    .badge {
        font-size: 0.75em;
    }

    .card-body h4, .card-body h6 {
        font-weight: 600;
    }

    .card {
        transition: all 0.3s ease;
    }

    .card:hover {
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .table th {
        border-top: none;
        font-weight: 600;
        color: #495057;
    }

    .btn-sm {
        font-size: 0.8rem;
    }

    /* Indicateurs de statut */
    .fa-power-off.text-success, .fa-lock.text-success,
    .fa-calendar-times.text-success, .fa-key.text-success {
        filter: drop-shadow(0 0 3px rgba(40, 167, 69, 0.3));
    }

    .fa-power-off.text-danger, .fa-lock.text-danger,
    .fa-calendar-times.text-danger, .fa-key.text-danger {
        filter: drop-shadow(0 0 3px rgba(220, 53, 69, 0.3));
    }

    /* Animation des notifications */
    .alert {
        animation: slideInRight 0.3s ease;
    }

    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>
<div th:fragment="content">
    <!-- Vérification que l'utilisateur existe -->
    <div th:if="${user == null}" class="alert alert-danger">
        <h4><i class="fas fa-exclamation-triangle me-2"></i>Utilisateur introuvable</h4>
        <p>L'utilisateur demandé n'existe pas ou a été supprimé.</p>
        <a th:href="@{/users}" class="btn btn-primary">Retour à la liste des utilisateurs</a>
    </div>

    <!-- Contenu principal si l'utilisateur existe -->
    <div th:if="${user != null}">
        <!-- En-tête -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>
                    <i class="fas fa-user-tie me-2"></i>
                    <span th:text="${user.fullName ?: 'Nom non défini'}">Nom de l'Utilisateur</span>
                    <span class="badge ms-2"
                          th:class="'badge ' + (${user.enabled} ? 'bg-success' : 'bg-danger')"
                          th:text="${user.enabled} ? 'Actif' : 'Inactif'">Statut</span>
                    <span class="badge bg-info ms-1" th:if="${user.hasRole('ADMIN')}">
                        <i class="fas fa-crown me-1"></i>Admin
                    </span>
                    <span class="badge bg-primary ms-1" th:if="${user.hasRole('COMMERCIAL')}">
                        <i class="fas fa-handshake me-1"></i>Commercial
                    </span>
                    <span class="badge bg-warning ms-1" th:if="${!user.accountNonLocked}">
                        <i class="fas fa-lock me-1"></i>Verrouillé
                    </span>
                </h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a th:href="@{/dashboard}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a th:href="@{/users}">Utilisateurs</a></li>
                        <li class="breadcrumb-item active" th:text="${user.fullName ?: 'Utilisateur'}">Utilisateur</li>
                    </ol>
                </nav>
            </div>
            <div class="btn-group">
                <a th:href="@{/users}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Retour à la liste
                </a>
                <a th:href="@{'/admin/users/' + ${user.id} + '/edit'}" class="btn btn-primary">
                    <i class="fas fa-edit me-2"></i>Modifier
                </a>
                <button class="btn btn-success" onclick="quickEdit()">
                    <i class="fas fa-bolt me-2"></i>Édition rapide
                </button>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="resetPassword()">
                            <i class="fas fa-key me-2"></i>Réinitialiser mot de passe
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="toggleAccount()">
                            <i class="fas fa-user-slash me-2"></i>
                            <span th:text="${user.enabled} ? 'Désactiver' : 'Activer'">Désactiver</span>
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="unlockAccount()" th:if="${!user.accountNonLocked}">
                            <i class="fas fa-unlock me-2"></i>Déverrouiller
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="exportUser()">
                            <i class="fas fa-download me-2"></i>Exporter
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="printUser()">
                            <i class="fas fa-print me-2"></i>Imprimer
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteUser()">
                            <i class="fas fa-trash me-2"></i>Supprimer
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Colonne principale -->
            <div class="col-lg-8">
                <!-- Informations générales -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informations Générales</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="fw-bold text-muted">Nom complet</label>
                                <p class="mb-0" th:text="${user.fullName}">Prénom Nom</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="fw-bold text-muted">Nom d'utilisateur</label>
                                <p class="mb-0 font-monospace" th:text="${user.username}">username</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="fw-bold text-muted">Email</label>
                                <p class="mb-0">
                                    <a th:href="'mailto:' + ${user.email}" th:text="${user.email}" class="text-decoration-none">
                                        email@company.com
                                    </a>
                                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard(this.previousElementSibling.textContent)" title="Copier">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </p>
                            </div>
                            <div class="col-md-6 mb-3" th:if="${user.lastLogin != null}">
                                <label class="fw-bold text-muted">Dernière connexion</label>
                                <p class="mb-0" th:text="${#temporals.format(user.lastLogin, 'dd/MM/yyyy HH:mm')}">25/07/2025 14:30</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statut du compte -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Statut du Compte</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <i class="fas fa-power-off fa-2x" th:class="'fas fa-power-off fa-2x ' + (${user.enabled} ? 'text-success' : 'text-danger')"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0">Compte</h6>
                                        <span th:text="${user.enabled} ? 'Activé' : 'Désactivé'"
                                              th:class="${user.enabled} ? 'text-success' : 'text-danger'">Activé</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <i class="fas fa-lock fa-2x" th:class="'fas fa-lock fa-2x ' + (${user.accountNonLocked} ? 'text-success' : 'text-danger')"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0">Verrouillage</h6>
                                        <span th:text="${user.accountNonLocked} ? 'Non verrouillé' : 'Verrouillé'"
                                              th:class="${user.accountNonLocked} ? 'text-success' : 'text-danger'">Non verrouillé</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <i class="fas fa-calendar-times fa-2x" th:class="'fas fa-calendar-times fa-2x ' + (${user.accountNonExpired} ? 'text-success' : 'text-danger')"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0">Expiration</h6>
                                        <span th:text="${user.accountNonExpired} ? 'Non expiré' : 'Expiré'"
                                              th:class="${user.accountNonExpired} ? 'text-success' : 'text-danger'">Non expiré</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <i class="fas fa-key fa-2x" th:class="'fas fa-key fa-2x ' + (${user.credentialsNonExpired} ? 'text-success' : 'text-danger')"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0">Identifiants</h6>
                                        <span th:text="${user.credentialsNonExpired} ? 'Valides' : 'Expirés'"
                                              th:class="${user.credentialsNonExpired} ? 'text-success' : 'text-danger'">Valides</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rôles et Permissions -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-users-cog me-2"></i>Rôles et Permissions</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="manageRoles()">
                                <i class="fas fa-cog me-1"></i>Gérer les Rôles
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="managePermissions()">
                                <i class="fas fa-key me-1"></i>Permissions
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="fw-bold text-muted">Rôles assignés</label>
                                <div class="mt-2">
                                    <span th:each="role : ${user.roles}"
                                          th:class="'badge me-2 mb-2 ' + (${role.name == 'ADMIN'} ? 'bg-danger' : (${role.name == 'MANAGER'} ? 'bg-warning' : 'bg-primary'))"
                                          th:text="${role.name}">ROLE_USER</span>
                                    <span th:if="${#lists.isEmpty(user.roles)}" class="text-muted">Aucun rôle assigné</span>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="fw-bold text-muted">Permissions actives</label>
                                <div class="mt-2" style="max-height: 150px; overflow-y: auto;">
                                    <div th:each="authority : ${user.authorities}" class="d-flex align-items-center mb-1">
                                        <i class="fas fa-check text-success me-2"></i>
                                        <small th:text="${authority.authority}" class="text-muted">PERMISSION</small>
                                    </div>
                                    <div th:if="${#lists.isEmpty(user.authorities)}" class="text-muted">
                                        <i class="fas fa-times text-danger me-2"></i>
                                        <small>Aucune permission active</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Actions rapides -->
                        <div class="mt-3 pt-3 border-top">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="fw-bold text-muted mb-2">Actions rapides</label>
                                    <div class="d-flex flex-wrap gap-2">
                                        <button class="btn btn-sm btn-outline-success" onclick="promoteToAdmin()" th:if="${!user.hasRole('ADMIN')}">
                                            <i class="fas fa-crown me-1"></i>Promouvoir Admin
                                        </button>
                                        <button class="btn btn-sm btn-outline-warning" onclick="assignManager()" th:if="${!user.hasRole('MANAGER')}">
                                            <i class="fas fa-users me-1"></i>Nommer Manager
                                        </button>
                                        <button class="btn btn-sm btn-outline-info" onclick="assignCommercial()" th:if="${!user.hasRole('COMMERCIAL')}">
                                            <i class="fas fa-handshake me-1"></i>Assigner Commercial
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="fw-bold text-muted mb-2">Permissions temporaires</label>
                                    <div class="d-flex flex-wrap gap-2">
                                        <button class="btn btn-sm btn-outline-primary" onclick="grantTempAccess()">
                                            <i class="fas fa-clock me-1"></i>Accès temporaire
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="viewAuditLog()">
                                            <i class="fas fa-history me-1"></i>Journal d'audit
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Objectifs commerciaux -->
                <div class="card mb-4" th:if="${user.hasRole('COMMERCIAL')}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-bullseye me-2"></i>Objectifs Commerciaux</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="updateTargets()">
                            <i class="fas fa-edit me-1"></i>Modifier
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="text-center p-3 bg-light rounded">
                                    <h4 class="text-primary mb-1" th:text="${#numbers.formatDecimal(user.personalTarget, 1, 0)} + ' €'">20 000 €</h4>
                                    <small class="text-muted">Objectif personnel</small>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="text-center p-3 bg-light rounded">
                                    <h4 class="text-info mb-1" th:text="${#numbers.formatDecimal(user.teamTarget, 1, 0)} + ' €'">100 000 €</h4>
                                    <small class="text-muted">Objectif équipe</small>
                                </div>
                            </div>
                        </div>

                        <!-- Progression -->
                        <div class="row">
                            <div class="col-12">
                                <label class="fw-bold text-muted small">Progression personnelle</label>
                                <div class="progress mb-2" style="height: 10px;">
                                    <div class="progress-bar bg-success" style="width: 65%" title="65% de l'objectif atteint"></div>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <small class="text-muted">13 000 € réalisés</small>
                                    <small class="text-success">65%</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activité récente -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-history me-2"></i>Activité Récente</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Action</th>
                                    <th>Détails</th>
                                    <th>Statut</th>
                                </tr>
                                </thead>
                                <tbody>
                                <!-- Exemple d'activité -->
                                <tr>
                                    <td>25/07/2025 14:30</td>
                                    <td><i class="fas fa-sign-in-alt text-success me-1"></i>Connexion</td>
                                    <td>Connexion depuis 192.168.1.100</td>
                                    <td><span class="badge bg-success">Succès</span></td>
                                </tr>
                                <tr>
                                    <td>25/07/2025 10:15</td>
                                    <td><i class="fas fa-shopping-cart text-primary me-1"></i>Commande</td>
                                    <td>Création commande CMD-2025-001</td>
                                    <td><span class="badge bg-primary">Créée</span></td>
                                </tr>
                                <tr>
                                    <td>24/07/2025 16:45</td>
                                    <td><i class="fas fa-user-plus text-info me-1"></i>Client</td>
                                    <td>Nouveau client: Jean Dupont</td>
                                    <td><span class="badge bg-info">Ajouté</span></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Colonne latérale -->
            <div class="col-lg-4">
                <!-- Photo et infos rapides -->
                <div class="card mb-4">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center"
                                 style="width: 80px; height: 80px;">
                                <i class="fas fa-user fa-2x text-primary"></i>
                            </div>
                        </div>
                        <h5 class="mb-1" th:text="${user.fullName}">Nom Complet</h5>
                        <p class="text-muted mb-3" th:text="${user.username}">@username</p>
                        <div class="row text-center">
                            <div class="col-6">
                                <h6 class="text-primary mb-0">12</h6>
                                <small class="text-muted">Clients</small>
                            </div>
                            <div class="col-6">
                                <h6 class="text-success mb-0">34</h6>
                                <small class="text-muted">Commandes</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance -->
                <div class="card mb-4" th:if="${user.hasRole('COMMERCIAL')}">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Performance</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 mb-3">
                                <h4 class="text-success mb-0">€ 13k</h4>
                                <small class="text-muted">CA ce mois</small>
                            </div>
                            <div class="col-6 mb-3">
                                <h4 class="text-primary mb-0">€ 156k</h4>
                                <small class="text-muted">CA total</small>
                            </div>
                            <div class="col-6">
                                <h4 class="text-info mb-0">€ 458</h4>
                                <small class="text-muted">Panier moyen</small>
                            </div>
                            <div class="col-6">
                                <h4 class="text-warning mb-0">92%</h4>
                                <small class="text-muted">Taux de conversion</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions de gestion -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-tools me-2"></i>Actions de Gestion</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="sendMessage()">
                                <i class="fas fa-envelope me-2"></i>Envoyer un message
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="viewClients()">
                                <i class="fas fa-users me-2"></i>Voir ses clients
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="viewOrders()">
                                <i class="fas fa-shopping-cart me-2"></i>Voir ses commandes
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="generateReport()">
                                <i class="fas fa-chart-bar me-2"></i>Rapport d'activité
                            </button>
                            <hr>
                            <button class="btn btn-outline-secondary btn-sm" onclick="impersonateUser()" th:if="${!user.hasRole('ADMIN')}">
                                <i class="fas fa-user-secret me-2"></i>Se connecter en tant que
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Informations système -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-info me-2"></i>Informations Système</h6>
                    </div>
                    <div class="card-body">
                        <small class="text-muted" th:if="${user.createdAt != null}">
                            <strong>Créé le :</strong><br>
                            <span th:text="${#temporals.format(user.createdAt, 'dd/MM/yyyy HH:mm')}">25/07/2025 10:30</span>
                        </small><br>
                        <small class="text-muted" th:if="${user.updatedAt != null}">
                            <strong>Modifié le :</strong><br>
                            <span th:text="${#temporals.format(user.updatedAt, 'dd/MM/yyyy HH:mm')}">25/07/2025 14:15</span>
                        </small><br>
                        <small class="text-muted">
                            <strong>ID :</strong> <span th:text="'#' + ${user.id}">#123</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de gestion des rôles -->
<div class="modal fade" id="rolesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-users-cog me-2"></i>Gérer les Rôles</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="rolesForm" th:action="@{'/admin/users/' + ${user.id} + '/roles'}" method="post">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Information :</strong> Les rôles déterminent les permissions générales de l'utilisateur.
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary"><i class="fas fa-shield-alt me-2"></i>Rôles principaux</h6>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="roleAdmin" name="roles" value="ADMIN" 
                                       th:checked="${user.hasRole('ADMIN')}">
                                <label class="form-check-label" for="roleAdmin">
                                    <strong class="text-danger">Administrateur</strong>
                                    <br><small class="text-muted">Accès complet au système</small>
                                </label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="roleManager" name="roles" value="MANAGER"
                                       th:checked="${user.hasRole('MANAGER')}">
                                <label class="form-check-label" for="roleManager">
                                    <strong class="text-warning">Manager</strong>
                                    <br><small class="text-muted">Gestion d'équipe et rapports</small>
                                </label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="roleCommercial" name="roles" value="COMMERCIAL"
                                       th:checked="${user.hasRole('COMMERCIAL')}">
                                <label class="form-check-label" for="roleCommercial">
                                    <strong class="text-primary">Commercial</strong>
                                    <br><small class="text-muted">Gestion clients et commandes</small>
                                </label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="roleUser" name="roles" value="USER"
                                       th:checked="${user.hasRole('USER')}">
                                <label class="form-check-label" for="roleUser">
                                    <strong class="text-info">Utilisateur</strong>
                                    <br><small class="text-muted">Accès de base</small>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success"><i class="fas fa-key me-2"></i>Permissions spéciales</h6>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="permViewReports" name="permissions" value="VIEW_REPORTS">
                                <label class="form-check-label" for="permViewReports">
                                    <strong>Voir les rapports</strong>
                                    <br><small class="text-muted">Accès aux statistiques avancées</small>
                                </label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="permManageUsers" name="permissions" value="MANAGE_USERS">
                                <label class="form-check-label" for="permManageUsers">
                                    <strong>Gérer les utilisateurs</strong>
                                    <br><small class="text-muted">Création/modification utilisateurs</small>
                                </label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="permManageProducts" name="permissions" value="MANAGE_PRODUCTS">
                                <label class="form-check-label" for="permManageProducts">
                                    <strong>Gérer les produits</strong>
                                    <br><small class="text-muted">Catalogue et stocks</small>
                                </label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="permViewFinancial" name="permissions" value="VIEW_FINANCIAL">
                                <label class="form-check-label" for="permViewFinancial">
                                    <strong>Données financières</strong>
                                    <br><small class="text-muted">CA, bénéfices, coûts</small>
                                </label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="permSystemConfig" name="permissions" value="SYSTEM_CONFIG">
                                <label class="form-check-label" for="permSystemConfig">
                                    <strong>Configuration système</strong>
                                    <br><small class="text-muted">Paramètres globaux</small>
                                </label>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-warning"><i class="fas fa-clock me-2"></i>Permissions temporaires</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="tempAdminAccess">
                                        <label class="form-check-label" for="tempAdminAccess">
                                            Accès admin temporaire
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <input type="datetime-local" class="form-control form-control-sm" 
                                           placeholder="Date d'expiration" id="tempAccessExpiry">
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-warning" onclick="resetToDefault()">
                    <i class="fas fa-undo me-2"></i>Réinitialiser
                </button>
                <button type="button" class="btn btn-primary" onclick="saveRoles()">
                    <i class="fas fa-save me-2"></i>Enregistrer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de gestion des permissions détaillées -->
<div class="modal fade" id="permissionsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-key me-2"></i>Gestion Détaillée des Permissions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="nav flex-column nav-pills" role="tablist">
                            <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#clients-permissions" role="tab">
                                <i class="fas fa-users me-2"></i>Clients
                            </button>
                            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#products-permissions" role="tab">
                                <i class="fas fa-box me-2"></i>Produits
                            </button>
                            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#orders-permissions" role="tab">
                                <i class="fas fa-shopping-cart me-2"></i>Commandes
                            </button>
                            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#financial-permissions" role="tab">
                                <i class="fas fa-euro-sign me-2"></i>Financier
                            </button>
                            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#admin-permissions" role="tab">
                                <i class="fas fa-cog me-2"></i>Administration
                            </button>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="clients-permissions">
                                <h6 class="text-primary mb-3">Permissions sur les Clients</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="clientView">
                                            <label class="form-check-label" for="clientView">Voir les clients</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="clientCreate">
                                            <label class="form-check-label" for="clientCreate">Créer des clients</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="clientEdit">
                                            <label class="form-check-label" for="clientEdit">Modifier les clients</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="clientDelete">
                                            <label class="form-check-label" for="clientDelete">Supprimer les clients</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="clientAssign">
                                            <label class="form-check-label" for="clientAssign">Assigner des clients</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="clientExport">
                                            <label class="form-check-label" for="clientExport">Exporter les données</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="clientViewAll">
                                            <label class="form-check-label" for="clientViewAll">Voir tous les clients</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="products-permissions">
                                <h6 class="text-success mb-3">Permissions sur les Produits</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="productView">
                                            <label class="form-check-label" for="productView">Voir les produits</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="productCreate">
                                            <label class="form-check-label" for="productCreate">Créer des produits</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="productEdit">
                                            <label class="form-check-label" for="productEdit">Modifier les produits</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="productDelete">
                                            <label class="form-check-label" for="productDelete">Supprimer les produits</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="stockManage">
                                            <label class="form-check-label" for="stockManage">Gérer les stocks</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="priceEdit">
                                            <label class="form-check-label" for="priceEdit">Modifier les prix</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="categoryManage">
                                            <label class="form-check-label" for="categoryManage">Gérer les catégories</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="orders-permissions">
                                <h6 class="text-info mb-3">Permissions sur les Commandes</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="orderView">
                                            <label class="form-check-label" for="orderView">Voir les commandes</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="orderCreate">
                                            <label class="form-check-label" for="orderCreate">Créer des commandes</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="orderEdit">
                                            <label class="form-check-label" for="orderEdit">Modifier les commandes</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="orderCancel">
                                            <label class="form-check-label" for="orderCancel">Annuler les commandes</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="orderValidate">
                                            <label class="form-check-label" for="orderValidate">Valider les commandes</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="invoiceGenerate">
                                            <label class="form-check-label" for="invoiceGenerate">Générer des factures</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="orderViewAll">
                                            <label class="form-check-label" for="orderViewAll">Voir toutes les commandes</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="financial-permissions">
                                <h6 class="text-warning mb-3">Permissions Financières</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="financeViewCA">
                                            <label class="form-check-label" for="financeViewCA">Voir le CA</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="financeViewCosts">
                                            <label class="form-check-label" for="financeViewCosts">Voir les coûts</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="financeViewMargins">
                                            <label class="form-check-label" for="financeViewMargins">Voir les marges</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="financeExport">
                                            <label class="form-check-label" for="financeExport">Exporter données financières</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="financeReports">
                                            <label class="form-check-label" for="financeReports">Rapports financiers</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="admin-permissions">
                                <h6 class="text-danger mb-3">Permissions d'Administration</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="adminUsers">
                                            <label class="form-check-label" for="adminUsers">Gérer les utilisateurs</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="adminRoles">
                                            <label class="form-check-label" for="adminRoles">Gérer les rôles</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="adminConfig">
                                            <label class="form-check-label" for="adminConfig">Configuration système</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="adminLogs">
                                            <label class="form-check-label" for="adminLogs">Voir les logs</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="adminBackup">
                                            <label class="form-check-label" for="adminBackup">Gestion des sauvegardes</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="adminMaintenance">
                                            <label class="form-check-label" for="adminMaintenance">Mode maintenance</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-info" onclick="previewPermissions()">
                    <i class="fas fa-eye me-2"></i>Aperçu
                </button>
                <button type="button" class="btn btn-primary" onclick="saveDetailedPermissions()">
                    <i class="fas fa-save me-2"></i>Enregistrer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de modification des objectifs -->
<div class="modal fade" id="targetsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modifier les Objectifs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="targetsForm">
                    <div class="mb-3">
                        <label class="form-label">Objectif personnel (€)</label>
                        <input type="number" class="form-control" id="personalTarget"
                               th:value="${user.personalTarget}" step="1000" min="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Période</label>
                        <select class="form-select" id="targetPeriod">
                            <option value="monthly">Mensuel</option>
                            <option value="quarterly">Trimestriel</option>
                            <option value="yearly">Annuel</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" rows="3" placeholder="Commentaires sur l'objectif..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="saveTargets()">Enregistrer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmation de suppression -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmer la suppression</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir supprimer cet utilisateur ?</p>
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Attention :</strong> Cette action supprimera également toutes les données associées.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">Supprimer</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<th:block th:fragment="js_assets">
    <script th:inline="javascript">
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function() {
            showNotification('Copié dans le presse-papiers !', 'success');
        }).catch(function() {
            showNotification('Erreur lors de la copie', 'error');
        });
    }

    function resetPassword() {
        if (confirm('Êtes-vous sûr de vouloir réinitialiser le mot de passe ?')) {
            var userId = window.location.pathname.split('/').pop();
            // Envoyer la requête de réinitialisation
            fetch(`/users/${userId}/reset-password`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Mot de passe réinitialisé avec succès !', 'success');
                    } else {
                        showNotification('Erreur lors de la réinitialisation', 'error');
                    }
                })
                .catch(error => {
                    showNotification('Erreur de connexion', 'error');
                });
        }
    }

    function toggleAccount() {
        var userId = window.location.pathname.split('/').pop();
        var isEnabled = document.querySelector('.badge.bg-success, .badge.bg-danger').textContent === 'Actif';
        var action = isEnabled ? 'disable' : 'enable';

        if (confirm(`Êtes-vous sûr de vouloir ${isEnabled ? 'désactiver' : 'activer'} ce compte ?`)) {
            showNotification(`Compte ${isEnabled ? 'désactivé' : 'activé'} avec succès !`, 'success');
            setTimeout(() => location.reload(), 1000);
        }
    }

    function unlockAccount() {
        var userId = window.location.pathname.split('/').pop();
        if (confirm('Êtes-vous sûr de vouloir déverrouiller ce compte ?')) {
            showNotification('Compte déverrouillé avec succès !', 'success');
            setTimeout(() => location.reload(), 1000);
        }
    }

    function manageRoles() {
        // Charger les rôles actuels de l'utilisateur
        loadCurrentRoles();
        var rolesModal = new bootstrap.Modal(document.getElementById('rolesModal'));
        rolesModal.show();
    }

    function managePermissions() {
        var permissionsModal = new bootstrap.Modal(document.getElementById('permissionsModal'));
        permissionsModal.show();
    }

    function loadCurrentRoles() {
        // Cocher les rôles actuels basés sur les badges affichés
        const roleBadges = document.querySelectorAll('.card-body .badge');
        const currentRoles = Array.from(roleBadges).map(badge => badge.textContent.trim());
        
        // Décocher tous les rôles d'abord
        document.querySelectorAll('#rolesForm input[name="roles"]').forEach(input => {
            input.checked = false;
        });
        
        // Cocher les rôles actuels
        currentRoles.forEach(role => {
            const checkbox = document.querySelector(`#rolesForm input[value="${role}"]`);
            if (checkbox) {
                checkbox.checked = true;
            }
        });
    }

    function saveRoles() {
        var form = document.getElementById('rolesForm');
        var formData = new FormData(form);
        var userId = window.location.pathname.split('/').pop();
        
        // Récupérer les rôles sélectionnés
        const selectedRoles = [];
        const selectedPermissions = [];
        
        formData.getAll('roles').forEach(role => selectedRoles.push(role));
        formData.getAll('permissions').forEach(perm => selectedPermissions.push(perm));
        
        // Simuler l'envoi au serveur
        fetch(`/admin/users/${userId}/roles`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                roles: selectedRoles,
                permissions: selectedPermissions
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('rolesModal')).hide();
                showNotification('Rôles et permissions mis à jour avec succès !', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification('Erreur lors de la mise à jour', 'error');
            }
        })
        .catch(error => {
            console.log('Simulation - Rôles mis à jour:', {roles: selectedRoles, permissions: selectedPermissions});
            bootstrap.Modal.getInstance(document.getElementById('rolesModal')).hide();
            showNotification('Rôles mis à jour avec succès !', 'success');
        });
    }

    function saveDetailedPermissions() {
        const permissions = {};
        
        // Récupérer toutes les permissions cochées
        document.querySelectorAll('#permissionsModal input[type="checkbox"]:checked').forEach(input => {
            const category = input.closest('.tab-pane').id.replace('-permissions', '');
            if (!permissions[category]) permissions[category] = [];
            permissions[category].push(input.id);
        });
        
        console.log('Permissions détaillées:', permissions);
        
        bootstrap.Modal.getInstance(document.getElementById('permissionsModal')).hide();
        showNotification('Permissions détaillées mises à jour !', 'success');
    }

    function resetToDefault() {
        if (confirm('Réinitialiser aux rôles et permissions par défaut ?')) {
            // Décocher tous les rôles sauf USER
            document.querySelectorAll('#rolesForm input[name="roles"]').forEach(input => {
                input.checked = input.value === 'USER';
            });
            
            // Décocher toutes les permissions spéciales
            document.querySelectorAll('#rolesForm input[name="permissions"]').forEach(input => {
                input.checked = false;
            });
            
            showNotification('Rôles réinitialisés aux valeurs par défaut', 'info');
        }
    }

    function previewPermissions() {
        const selectedPerms = [];
        document.querySelectorAll('#permissionsModal input[type="checkbox"]:checked').forEach(input => {
            selectedPerms.push(input.nextElementSibling.textContent.trim());
        });
        
        const preview = selectedPerms.length > 0 ? 
            `Permissions sélectionnées:\n${selectedPerms.join('\n')}` : 
            'Aucune permission sélectionnée';
            
        alert(preview);
    }

    function updateTargets() {
        var targetsModal = new bootstrap.Modal(document.getElementById('targetsModal'));
        targetsModal.show();
    }

    function saveTargets() {
        var form = document.getElementById('targetsForm');
        var formData = new FormData(form);

        console.log('Objectifs mis à jour:', Object.fromEntries(formData));

        bootstrap.Modal.getInstance(document.getElementById('targetsModal')).hide();
        showNotification('Objectifs mis à jour avec succès !', 'success');
    }

    function sendMessage() {
        var email = document.querySelector('a[href^="mailto:"]');
        if (email) {
            window.location.href = email.href + '?subject=Message depuis le système de gestion';
        }
    }

    function viewClients() {
        var userId = window.location.pathname.split('/').pop();
        window.location.href = `/clients?assignedUserId=${userId}`;
    }

    function viewOrders() {
        var userId = window.location.pathname.split('/').pop();
        window.location.href = `/orders?userId=${userId}`;
    }

    function generateReport() {
        var userId = window.location.pathname.split('/').pop();
        window.open(`/users/${userId}/report`, '_blank');
    }

    function impersonateUser() {
        var userId = window.location.pathname.split('/').pop();
        if (confirm('Vous allez vous connecter en tant que cet utilisateur. Continuer ?')) {
            window.location.href = `/admin/impersonate/${userId}`;
        }
    }

    function deleteUser() {
        var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        deleteModal.show();
    }

    function confirmDelete() {
        var userId = window.location.pathname.split('/').pop();
        window.location.href = `/users/delete/${userId}`;
    }

    function exportUser() {
        var userId = window.location.pathname.split('/').pop();
        window.location.href = `/users/export/${userId}`;
    }

    function printUser() {
        window.print();
    }

    // Nouvelles fonctions pour les actions rapides
    function quickEdit() {
        const userInfo = {
            firstName: prompt('Prénom:', document.querySelector('.card-body p').textContent.split(' ')[0]),
            lastName: prompt('Nom:', document.querySelector('.card-body p').textContent.split(' ')[1]),
            email: document.querySelector('a[href^="mailto:"]').textContent,
            enabled: confirm('Compte actif ?')
        };
        
        if (userInfo.firstName && userInfo.lastName) {
            console.log('Édition rapide:', userInfo);
            showNotification('Informations mises à jour rapidement !', 'success');
        }
    }

    function promoteToAdmin() {
        if (confirm('Promouvoir cet utilisateur au rang d\'administrateur ?\n\nCela lui donnera tous les privilèges système.')) {
            var userId = window.location.pathname.split('/').pop();
            
            fetch(`/admin/users/${userId}/promote-admin`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                showNotification('Utilisateur promu administrateur !', 'success');
                setTimeout(() => location.reload(), 1500);
            })
            .catch(error => {
                console.log('Simulation - Promotion admin');
                showNotification('Utilisateur promu administrateur !', 'success');
                setTimeout(() => location.reload(), 1500);
            });
        }
    }

    function assignManager() {
        if (confirm('Assigner le rôle de Manager à cet utilisateur ?\n\nIl pourra gérer son équipe et voir les rapports.')) {
            var userId = window.location.pathname.split('/').pop();
            
            console.log('Assignation Manager pour utilisateur:', userId);
            showNotification('Rôle Manager assigné !', 'success');
            setTimeout(() => location.reload(), 1500);
        }
    }

    function assignCommercial() {
        const targetAmount = prompt('Objectif de vente mensuel (€):', '20000');
        if (targetAmount && confirm(`Assigner le rôle Commercial avec un objectif de ${targetAmount}€ ?`)) {
            var userId = window.location.pathname.split('/').pop();
            
            console.log('Assignation Commercial:', {userId, target: targetAmount});
            showNotification('Rôle Commercial assigné avec objectif !', 'success');
            setTimeout(() => location.reload(), 1500);
        }
    }

    function grantTempAccess() {
        const duration = prompt('Durée de l\'accès temporaire (en heures):', '24');
        const permissions = prompt('Permissions temporaires (séparées par des virgules):', 'VIEW_REPORTS,MANAGE_ORDERS');
        
        if (duration && permissions) {
            console.log('Accès temporaire accordé:', {duration, permissions: permissions.split(',')});
            showNotification(`Accès temporaire de ${duration}h accordé !`, 'warning');
        }
    }

    function viewAuditLog() {
        var userId = window.location.pathname.split('/').pop();
        
        // Simuler l'ouverture du journal d'audit
        const auditData = [
            {date: '2025-08-22 14:30', action: 'LOGIN', details: 'Connexion réussie depuis 192.168.1.100'},
            {date: '2025-08-22 10:15', action: 'ROLE_CHANGE', details: 'Rôle COMMERCIAL ajouté par admin'},
            {date: '2025-08-21 16:45', action: 'CLIENT_CREATE', details: 'Création client: Dupont SAS'},
            {date: '2025-08-21 09:30', action: 'ORDER_CREATE', details: 'Commande CMD-2025-001 créée'}
        ];
        
        let auditText = 'JOURNAL D\'AUDIT - Dernières activités:\n\n';
        auditData.forEach(entry => {
            auditText += `${entry.date} - ${entry.action}\n${entry.details}\n\n`;
        });
        
        alert(auditText);
    }

    function showNotification(message, type = 'info') {
        var alertClass = {
            'success': 'alert-success',
            'error': 'alert-danger',
            'warning': 'alert-warning',
            'info': 'alert-info'
        }[type] || 'alert-info';

        var alertDiv = document.createElement('div');
        alertDiv.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 350px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(alertDiv);

        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Page de détails utilisateur chargée');

        // Vérifier les alertes de sécurité
        var isEnabled = document.querySelector('.badge.bg-success, .badge.bg-danger').textContent === 'Actif';
        var isLocked = document.querySelector('.badge.bg-warning');

        if (!isEnabled) {
            setTimeout(() => {
                showNotification('Ce compte est désactivé !', 'warning');
            }, 1000);
        }

        if (isLocked && isLocked.textContent.includes('Verrouillé')) {
            setTimeout(() => {
                showNotification('Ce compte est verrouillé !', 'error');
            }, 1500);
        }
    });
</script>
 </th:block>
</body>
</html>