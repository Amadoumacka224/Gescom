<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: layout(~{::title}, ~{::content}, ~{::js_assets})}">
<head>
    <title th:text="${isEdit} ? 'Modifier la Facture' : 'Nouvelle Facture'">Formulaire Facture</title>
</head>
<body>
<div th:fragment="content">
    <!-- En-tête -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>
                <i class="fas fa-file-invoice-dollar me-2" th:unless="${isEdit}"></i>
                <i class="fas fa-edit me-2" th:if="${isEdit}"></i>
                <span th:text="${isEdit} ? 'Modifier la Facture' : 'Nouvelle Facture'">Formulaire Facture</span>
            </h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a th:href="@{/dashboard}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a th:href="@{/invoices}">Factures</a></li>
                    <li class="breadcrumb-item active" th:text="${isEdit} ? 'Modifier' : 'Nouvelle'">Formulaire</li>
                </ol>
            </nav>
        </div>
        <div>
            <a th:href="@{/invoices}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Retour à la liste
            </a>
        </div>
    </div>

    <!-- Formulaire -->
    <form th:action="@{/invoices}" th:object="${invoice}" method="post" novalidate>
        <!-- ID caché pour modification -->
        <input type="hidden" th:field="*{id}">

        <div class="row">
            <!-- Colonne principale -->
            <div class="col-lg-8">
                <!-- Informations de base -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Informations de la Facture</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="invoiceNumber" class="form-label">Numéro de facture <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="invoiceNumber" th:field="*{invoiceNumber}"
                                       th:classappend="${#fields.hasErrors('invoiceNumber')} ? 'is-invalid'"
                                       placeholder="FACT-001" required readonly>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('invoiceNumber')}" th:errors="*{invoiceNumber}">
                                    Erreur numéro facture
                                </div>
                                <small class="text-muted">Généré automatiquement</small>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="invoiceDate" class="form-label">Date de facture <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="invoiceDate" th:field="*{invoiceDate}"
                                       th:classappend="${#fields.hasErrors('invoiceDate')} ? 'is-invalid'"
                                       required>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('invoiceDate')}" th:errors="*{invoiceDate}">
                                    Erreur date facture
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="dueDate" class="form-label">Date d'échéance <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="dueDate" th:field="*{dueDate}"
                                       th:classappend="${#fields.hasErrors('dueDate')} ? 'is-invalid'"
                                       required>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('dueDate')}" th:errors="*{dueDate}">
                                    Erreur date échéance
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="order" class="form-label">Commande associée <span class="text-danger">*</span></label>
                                <select class="form-select" id="order" th:field="*{order.id}" required>
                                    <option value="">Sélectionner une commande</option>
                                    <option th:each="order : ${availableOrders}"
                                            th:value="${order.id}"
                                            th:text="${order.orderNumber + ' - ' + order.client.name + ' (' + #numbers.formatCurrency(order.totalAmount) + ')'}">
                                        CMD-001 - Client (€0)
                                    </option>
                                </select>
                                <small class="text-muted">Obligatoire - sélectionnez la commande à facturer</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Client et adresses -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Informations Client</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="invoiceType" class="form-label">Type de facture</label>
                                <select class="form-select" id="invoiceType" th:field="*{invoiceType}">
                                    <option th:each="type : ${T(com.gescom.entity.Invoice.InvoiceType).values()}"
                                            th:value="${type}"
                                            th:text="${type.displayName}">
                                        Type
                                    </option>
                                </select>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">Client (depuis commande)</label>
                                <input type="text" class="form-control" id="clientDisplay" readonly placeholder="Sélectionnez d'abord une commande">
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="paymentMethod" class="form-label">Méthode de paiement</label>
                                <select class="form-select" id="paymentMethod" th:field="*{paymentMethod}">
                                    <option value="">Sélectionner</option>
                                    <option th:each="method : ${T(com.gescom.entity.Invoice.PaymentMethod).values()}"
                                            th:value="${method}"
                                            th:text="${method.displayName}">
                                        Méthode
                                    </option>
                                </select>
                            </div>

                            <div class="col-12 mb-3">
                                <label for="billingAddress" class="form-label">Adresse de facturation <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="billingAddress" th:field="*{billingAddress}"
                                          th:classappend="${#fields.hasErrors('billingAddress')} ? 'is-invalid'"
                                          rows="3" placeholder="Adresse complète de facturation" required></textarea>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('billingAddress')}" th:errors="*{billingAddress}">
                                    Erreur adresse facturation
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lignes de facture -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Lignes de la Facture</h5>
                        <button type="button" class="btn btn-primary btn-sm" onclick="addInvoiceItem()">
                            <i class="fas fa-plus me-2"></i>Ajouter une ligne
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="invoiceItemsTable">
                                <thead class="table-light">
                                <tr>
                                    <th style="width: 30%">Description</th>
                                    <th style="width: 10%">Qté</th>
                                    <th style="width: 15%">Prix unitaire</th>
                                    <th style="width: 10%">Remise %</th>
                                    <th style="width: 10%">TVA %</th>
                                    <th style="width: 15%">Total HT</th>
                                    <th style="width: 10%">Actions</th>
                                </tr>
                                </thead>
                                <tbody id="invoiceItemsBody">
                                <!-- Template de ligne -->
                                <tr class="invoice-item-row d-none" id="itemRowTemplate">
                                    <td>
                                        <input type="text" class="form-control item-description"
                                               placeholder="Description du produit/service" required>
                                        <input type="hidden" class="item-reference">
                                        <input type="hidden" class="item-unit">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control item-quantity"
                                               min="1" value="1" required>
                                    </td>
                                    <td>
                                        <input type="number" class="form-control item-unit-price"
                                               step="0.01" min="0" placeholder="0.00" required>
                                    </td>
                                    <td>
                                        <input type="number" class="form-control item-discount"
                                               step="0.01" min="0" max="100" value="0">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control item-vat-rate"
                                               step="0.01" min="0" value="20">
                                    </td>
                                    <td>
                                        <span class="item-total-ht fw-bold">0.00 €</span>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-danger btn-sm" onclick="removeInvoiceItem(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="alert alert-info mt-3" id="noItemsAlert">
                            <i class="fas fa-info-circle me-2"></i>
                            Aucune ligne ajoutée. Cliquez sur "Ajouter une ligne" pour commencer.
                        </div>
                    </div>
                </div>

                <!-- Notes et conditions -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Notes et Conditions</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="notes" class="form-label">Notes internes</label>
                                <textarea class="form-control" id="notes" th:field="*{notes}"
                                          rows="3" placeholder="Notes internes (non visibles sur la facture)"></textarea>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="termsConditions" class="form-label">Conditions de paiement</label>
                                <textarea class="form-control" id="termsConditions" th:field="*{termsConditions}"
                                          rows="3" placeholder="Conditions générales et modalités de paiement"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Colonne latérale -->
            <div class="col-lg-4">
                <!-- Récapitulatif financier -->
                <div class="card mb-4 position-sticky" style="top: 20px;">
                    <div class="card-header">
                        <h5 class="mb-0">Récapitulatif</h5>
                    </div>
                    <div class="card-body">
                        <!-- Remises et frais -->
                        <div class="row mb-3">
                            <div class="col-6">
                                <label for="discountRate" class="form-label small">Remise %</label>
                                <input type="number" class="form-control form-control-sm" id="discountRate"
                                       th:field="*{discountRate}" step="0.01" min="0" max="100"
                                       placeholder="0.00" onchange="calculateTotals()">
                            </div>
                            <div class="col-6">
                                <label for="shippingCost" class="form-label small">Frais de port €</label>
                                <input type="number" class="form-control form-control-sm" id="shippingCost"
                                       th:field="*{shippingCost}" step="0.01" min="0"
                                       placeholder="0.00" onchange="calculateTotals()">
                            </div>
                        </div>

                        <hr>

                        <div class="d-flex justify-content-between mb-2">
                            <span>Sous-total HT :</span>
                            <span id="subtotalHT" class="fw-bold">0.00 €</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2" id="discountRow" style="display: none;">
                            <span>Remise :</span>
                            <span id="discountDisplay" class="text-danger">-0.00 €</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Total HT :</span>
                            <span id="totalHT" class="fw-bold">0.00 €</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Total TVA :</span>
                            <span id="totalVAT" class="fw-bold">0.00 €</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2" id="shippingRow" style="display: none;">
                            <span>Frais de port :</span>
                            <span id="shippingDisplay">0.00 €</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-3">
                            <span class="fs-5 fw-bold">Total TTC :</span>
                            <span id="totalTTC" class="fs-5 fw-bold text-primary">0.00 €</span>
                        </div>

                        <!-- Champs cachés pour les totaux -->
                        <input type="hidden" th:field="*{discountAmount}" id="hiddenDiscountAmount">
                        <input type="hidden" th:field="*{totalAmountHT}" id="hiddenTotalHT">
                        <input type="hidden" th:field="*{totalVatAmount}" id="hiddenTotalVAT">
                        <input type="hidden" th:field="*{totalAmount}" id="hiddenTotalTTC">

                        <!-- Statut -->
                        <div class="mb-3">
                            <label for="status" class="form-label">Statut</label>
                            <select class="form-select" id="status" th:field="*{status}">
                                <option th:each="status : ${T(com.gescom.entity.Invoice.InvoiceStatus).values()}"
                                        th:value="${status}"
                                        th:text="${status.displayName}">
                                    Statut
                                </option>
                            </select>
                        </div>

                        <!-- Paiement -->
                        <div id="paymentSection" style="display: none;">
                            <div class="mb-3">
                                <label for="paidAmount" class="form-label">Montant payé</label>
                                <input type="number" class="form-control" id="paidAmount" th:field="*{paidAmount}"
                                       step="0.01" min="0" placeholder="0.00">
                            </div>
                            <div class="mb-3">
                                <label for="paymentDate" class="form-label">Date de paiement</label>
                                <input type="date" class="form-control" id="paymentDate" th:field="*{paymentDate}">
                            </div>
                            <div class="mb-3">
                                <label for="paymentReference" class="form-label">Référence paiement</label>
                                <input type="text" class="form-control" id="paymentReference" th:field="*{paymentReference}"
                                       placeholder="Numéro de transaction, chèque...">
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-2"></i>
                                <span th:text="${isEdit} ? 'Mettre à jour' : 'Créer la facture'">Sauvegarder</span>
                            </button>

                            <button type="button" class="btn btn-outline-primary" onclick="previewInvoice()" th:if="${isEdit}">
                                <i class="fas fa-eye me-2"></i>Aperçu
                            </button>

                            <button type="button" class="btn btn-outline-secondary" onclick="generatePDF()" th:if="${isEdit}">
                                <i class="fas fa-file-pdf me-2"></i>Générer PDF
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Aide -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-question-circle me-2"></i>Aide</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                <i class="fas fa-lightbulb text-warning me-2"></i>
                                <small>Le numéro de facture est généré automatiquement</small>
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-lightbulb text-warning me-2"></i>
                                <small>Liez une commande pour remplir automatiquement les lignes</small>
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-lightbulb text-warning me-2"></i>
                                <small>Le statut "Brouillon" permet de modifier la facture</small>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<th:block th:fragment="js_assets">
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const statusSelect = document.getElementById('status');
            const paymentSection = document.getElementById('paymentSection');
            const orderSelect = document.getElementById('order');
            const clientDisplay = document.getElementById('clientDisplay');

            // Gestion de l'affichage des champs de paiement
            function togglePaymentFields() {
                const status = statusSelect.value;
                const isPaidOrPartial = status === 'PAID' || status === 'PARTIAL';
                paymentSection.style.display = isPaidOrPartial ? 'block' : 'none';

                if (isPaidOrPartial) {
                    document.getElementById('paidAmount').required = true;
                    document.getElementById('paymentDate').required = true;
                } else {
                    document.getElementById('paidAmount').required = false;
                    document.getElementById('paymentDate').required = false;
                }
            }

            // Charger les données de la commande sélectionnée
            function loadOrderData() {
                const orderId = orderSelect.value;
                if (orderId) {
                    // Appel AJAX pour charger les données de la commande
                    fetch(`/api/orders/${orderId}`)
                        .then(response => {
                            if (!response.ok) throw new Error('Erreur lors du chargement de la commande');
                            return response.json();
                        })
                        .then(order => {
                            // Remplir les informations client
                            const clientDisplay = document.getElementById('clientDisplay');
                            if (clientDisplay) {
                                clientDisplay.value = `${order.client.name} (${order.client.email})`;
                            }

                            // Remplir l'adresse de facturation
                            const billingAddress = document.getElementById('billingAddress');
                            if (billingAddress && order.billingAddress) {
                                billingAddress.value = order.billingAddress;
                            }

                            // Charger les lignes de commande dans la facture
                            if (order.orderItems && order.orderItems.length > 0) {
                                loadOrderItemsIntoInvoice(order.orderItems);
                            }
                        })
                        .catch(error => {
                            console.error('Erreur:', error);
                            // Fallback : affichage basique
                            const selectedOption = orderSelect.options[orderSelect.selectedIndex];
                            if (selectedOption && selectedOption.text) {
                                const parts = selectedOption.text.split(' - ');
                                if (parts.length > 1) {
                                    document.getElementById('clientDisplay').value = parts[1].split(' (')[0];
                                }
                            }
                        });
                }
            }


            // Calcul automatique des totaux
            function calculateTotals() {
                let subtotalHT = 0;
                let totalVAT = 0;

                document.querySelectorAll('.invoice-item-row:not(.d-none)').forEach(row => {
                    const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                    const unitPrice = parseFloat(row.querySelector('.item-unit-price').value) || 0;
                    const discount = parseFloat(row.querySelector('.item-discount').value) || 0;
                    const vatRate = parseFloat(row.querySelector('.item-vat-rate').value) || 0;

                    const lineSubtotal = quantity * unitPrice;
                    const lineDiscount = lineSubtotal * (discount / 100);
                    const lineTotal = lineSubtotal - lineDiscount;
                    const lineVAT = lineTotal * vatRate / 100;

                    subtotalHT += lineTotal;
                    totalVAT += lineVAT;

                    // Mettre à jour l'affichage de la ligne
                    row.querySelector('.item-total-ht').textContent = lineTotal.toFixed(2) + ' €';
                });

                // Récupérer la remise globale et les frais de port
                const globalDiscountRate = parseFloat(document.getElementById('discountRate').value) || 0;
                const shippingCost = parseFloat(document.getElementById('shippingCost').value) || 0;

                // Calcul des remises et totaux
                const globalDiscountAmount = subtotalHT * (globalDiscountRate / 100);
                const totalHT = subtotalHT - globalDiscountAmount;
                const totalTTC = totalHT + totalVAT + shippingCost;

                // Mettre à jour l'affichage
                document.getElementById('subtotalHT').textContent = subtotalHT.toFixed(2) + ' €';
                document.getElementById('totalHT').textContent = totalHT.toFixed(2) + ' €';
                document.getElementById('totalVAT').textContent = totalVAT.toFixed(2) + ' €';
                document.getElementById('totalTTC').textContent = totalTTC.toFixed(2) + ' €';

                // Afficher/masquer les lignes conditionnelles
                const discountRow = document.getElementById('discountRow');
                const discountDisplay = document.getElementById('discountDisplay');
                if (globalDiscountAmount > 0) {
                    discountRow.style.display = 'flex';
                    discountDisplay.textContent = '-' + globalDiscountAmount.toFixed(2) + ' €';
                } else {
                    discountRow.style.display = 'none';
                }

                const shippingRow = document.getElementById('shippingRow');
                const shippingDisplay = document.getElementById('shippingDisplay');
                if (shippingCost > 0) {
                    shippingRow.style.display = 'flex';
                    shippingDisplay.textContent = shippingCost.toFixed(2) + ' €';
                } else {
                    shippingRow.style.display = 'none';
                }

                // Mettre à jour les champs cachés
                document.getElementById('hiddenDiscountAmount').value = globalDiscountAmount.toFixed(2);
                document.getElementById('hiddenTotalHT').value = totalHT.toFixed(2);
                document.getElementById('hiddenTotalVAT').value = totalVAT.toFixed(2);
                document.getElementById('hiddenTotalTTC').value = totalTTC.toFixed(2);
            }

            // Event listeners
            statusSelect.addEventListener('change', togglePaymentFields);
            orderSelect.addEventListener('change', loadOrderData);

            // Délégation d'événements pour les lignes dynamiques
            document.getElementById('invoiceItemsBody').addEventListener('input', function(e) {
                if (e.target.matches('.item-quantity, .item-unit-price, .item-discount, .item-vat-rate')) {
                    calculateTotals();
                }
            });

            // Initialiser les calculs au chargement
            calculateTotals();

            // Initialisation
            togglePaymentFields();
            updateNoItemsAlert();

            // Initialiser la date de facture à aujourd'hui
            const today = new Date().toISOString().split('T')[0];
            if (!document.getElementById('invoiceDate').value) {
                document.getElementById('invoiceDate').value = today;
            }

            // Calculer la date d'échéance (30 jours par défaut)
            if (!document.getElementById('dueDate').value) {
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + 30);
                document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];
            }
        });

        // Fonctions globales pour la gestion des lignes
        function addInvoiceItem() {
            const template = document.getElementById('itemRowTemplate');
            const tbody = document.getElementById('invoiceItemsBody');
            const newRow = template.cloneNode(true);

            // Générer un ID unique
            const uniqueId = 'item_' + Date.now();
            newRow.id = uniqueId;
            newRow.classList.remove('d-none');

            // Ajouter les attributs name pour la soumission du formulaire
            const inputs = newRow.querySelectorAll('input');
            const rowIndex = getRowIndex();
            inputs.forEach((input) => {
                const className = input.className.split(' ').find(cls => cls.startsWith('item-'));
                if (className) {
                    let fieldName;
                    switch(className) {
                        case 'item-description': fieldName = 'description'; break;
                        case 'item-reference': fieldName = 'reference'; break;
                        case 'item-unit': fieldName = 'unit'; break;
                        case 'item-quantity': fieldName = 'quantity'; break;
                        case 'item-unit-price': fieldName = 'unitPrice'; break;
                        case 'item-discount': fieldName = 'discountRate'; break;
                        case 'item-vat-rate': fieldName = 'vatRate'; break;
                        default: fieldName = className.replace('item-', '').replace('-', '');
                    }
                    input.name = `invoiceItems[${rowIndex}].${fieldName}`;
                }
            });

            tbody.appendChild(newRow);
            updateNoItemsAlert();

            // Focus sur la description
            newRow.querySelector('.item-description').focus();
        }

        function removeInvoiceItem(button) {
            const row = button.closest('tr');
            row.remove();
            updateNoItemsAlert();
            calculateTotals();
        }

        function updateNoItemsAlert() {
            const tbody = document.getElementById('invoiceItemsBody');
            const alert = document.getElementById('noItemsAlert');
            const visibleRows = tbody.querySelectorAll('.invoice-item-row:not(.d-none)').length;

            alert.style.display = visibleRows === 0 ? 'block' : 'none';
        }

        function getRowIndex() {
            const tbody = document.getElementById('invoiceItemsBody');
            const visibleRows = tbody.querySelectorAll('.invoice-item-row:not(.d-none)');
            return visibleRows.length;
        }

        function previewInvoice() {
            alert('Aperçu de la facture à implémenter');
        }

        function generatePDF() {
            alert('Génération PDF à implémenter');
        }

        // Fonction pour recalculer les totaux de ligne individuels
        function updateLineTotal(row) {
            const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
            const unitPrice = parseFloat(row.querySelector('.item-unit-price').value) || 0;
            const discount = parseFloat(row.querySelector('.item-discount').value) || 0;
            const vatRate = parseFloat(row.querySelector('.item-vat-rate').value) || 0;

            const lineTotal = quantity * unitPrice * (1 - discount / 100);

            // Mettre à jour l'affichage du total HT de la ligne
            row.querySelector('.item-total-ht').textContent = lineTotal.toFixed(2) + ' €';

            return {
                totalHT: lineTotal,
                vatAmount: lineTotal * vatRate / 100
            };
        }


        // Fonction pour charger les articles de commande dans la facture
        function loadOrderItemsIntoInvoice(orderItems) {
            // Vider les lignes existantes
            const tbody = document.getElementById('invoiceItemsBody');
            const existingRows = tbody.querySelectorAll('.invoice-item-row:not(.d-none)');
            existingRows.forEach(row => row.remove());

            // Ajouter chaque article de commande
            orderItems.forEach(orderItem => {
                const template = document.getElementById('itemRowTemplate');
                const newRow = template.cloneNode(true);

                // Générer un ID unique
                const uniqueId = 'item_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                newRow.id = uniqueId;
                newRow.classList.remove('d-none');

                // Remplir les données
                newRow.querySelector('.item-description').value = orderItem.product.name || orderItem.description || '';
                newRow.querySelector('.item-reference').value = orderItem.product.reference || '';
                newRow.querySelector('.item-unit').value = orderItem.product.unit || 'pièce';
                newRow.querySelector('.item-quantity').value = orderItem.quantity || 1;
                newRow.querySelector('.item-unit-price').value = orderItem.unitPrice || 0;
                newRow.querySelector('.item-discount').value = orderItem.discountRate || 0;
                newRow.querySelector('.item-vat-rate').value = orderItem.vatRate || 20;

                // Ajouter les attributs name pour la soumission
                const rowIndex = tbody.querySelectorAll('.invoice-item-row:not(.d-none)').length;
                const inputs = newRow.querySelectorAll('input');
                inputs.forEach((input) => {
                    const className = input.className.split(' ').find(cls => cls.startsWith('item-'));
                    if (className) {
                        let fieldName;
                        switch(className) {
                            case 'item-description': fieldName = 'description'; break;
                            case 'item-reference': fieldName = 'reference'; break;
                            case 'item-unit': fieldName = 'unit'; break;
                            case 'item-quantity': fieldName = 'quantity'; break;
                            case 'item-unit-price': fieldName = 'unitPrice'; break;
                            case 'item-discount': fieldName = 'discountRate'; break;
                            case 'item-vat-rate': fieldName = 'vatRate'; break;
                            default: fieldName = className.replace('item-', '').replace('-', '');
                        }
                        input.name = `invoiceItems[${rowIndex}].${fieldName}`;
                    }
                });

                tbody.appendChild(newRow);
            });

            updateNoItemsAlert();
            calculateTotals();
        }

        // Event listeners pour les changements de remise et frais de port
        document.addEventListener('DOMContentLoaded', function() {
            const discountRate = document.getElementById('discountRate');
            const shippingCost = document.getElementById('shippingCost');

            if (discountRate) {
                discountRate.addEventListener('input', calculateTotals);
            }

            if (shippingCost) {
                shippingCost.addEventListener('input', calculateTotals);
            }
        });
    </script>
</th:block>
</body>
</html>